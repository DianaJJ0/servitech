<!DOCTYPE html>
<!--
  Archivo: editarExpertos.ejs
  Propósito: Formulario para que un experto edite su perfil público y datos profesionales.
  Variables EJS esperadas:
    - experto: objeto experto (requerido para mostrar datos actuales)
    - categorias: array de categorías (opcional)
  Dependencias:
    - /assets/css/editarExperto.css, choices.js (si se usa para selects)
  Notas para Deepwiki:
    - Los campos bancarios y de pago deben manejarse con especial cuidado y validación server-side.
-->

<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Editar Perfil de Experto | Servitech</title>

  <link rel="stylesheet" href="/assets/css/editarExperto.css " />

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />
</head>

<body>
  <main class="registroExperto-main">
    <section class="registroExperto-section">
      <div id="alertasExpertos" class="registro-alerta"></div>


      <div class="registro-header">
        <div class="registro-header-content">
          <a href="/" class="logo-link">
            <img src="/assets/img/logo.png" alt="Logo de ServiTech" class="logo-img">
          </a>
          <h1 class="registro-header-title">Editar Perfil de Experto</h1>
          <p class="subtitle registro-header-subtitle">Actualiza tu información para mantener tu perfil al día</p>
        </div>
        <span id="currentDate" class="registro-fecha"></span>
        <div class="back-home-center">
          <a href="/perfil" class="back-link"><i class="fas fa-arrow-left"></i>Volver al perfil</a>
        </div>
      </div>

      <form id="editarExpertoForm" class="registroExperto-form" novalidate autocomplete="off">
        <!-- Sección de información básica -->
        <div class="form-section">
          <h2 class="form-section-title"><i class="fas fa-user"></i> Información básica</h2>
          <div class="form-row triple">
            <!-- Sección de email (solo lectura) OK -->
            <div class="form-group compact email-group">
              <label><i class="fas fa-envelope"></i> Email registrado</label>
              <div class="email-field" id="emailExperto">
                <%= experto && experto.email ? experto.email : "" %>
              </div>
              <p class="form-hint">Email de tu cuenta (no editable)</p>
            </div>


            <!-- Sección de precio OK-->
            <div class="form-group compact price-group">
              <label for="precio">Precio por hora (COP)
                <span class="price-tooltip" title="Ej: 30.000 - 100.000"><i class="fas fa-info-circle"></i></span>
              </label>

              <div class="price-input">
                <span class="currency">$</span>
                <input type="number" id="precio" name="precio" min="10000" max="100000" step="100" required
                  placeholder="Ej: 50000" inputmode="numeric" pattern="[0-9]*" data-maxlength="6" class="form-control"
                  aria-describedby="precio-help"
                  value="<%= experto && experto.infoExperto && experto.infoExperto.precioPorHora ? experto.infoExperto.precioPorHora : '' %>">
              </div>
              <div class="mensaje-error" id="errorPrecio"></div>
              <p class="form-hint" id="precio-help">Entre 10.000 y 120.000 (múltiplos de 100)</p>
            </div>

            <!-- Sección de teléfono -->
            <div class="form-group compact">
              <label for="telefonoContacto"><i class="fas fa-phone"></i> Teléfono de contacto</label>
              <input type="tel" id="telefonoContacto" name="telefonoContacto" placeholder="Ej: 3001234567"
                class="form-control" data-maxlength="13" aria-describedby="telefono-help"
                value="<%= experto && experto.infoExperto && experto.infoExperto.telefonoContacto ? experto.infoExperto.telefonoContacto : '' %>">
              <div class="mensaje-error" id="errorTelefono"></div>
              <p class="form-hint" id="telefono-help">Formato aceptado: 3001234567 o +573001234567 (solo números,
                opcional +57)</p>
            </div>

          </div>
        </div>

        <!-- Sección 2: Descripción profesional -->
        <div class="form-section">
          <h2 class="form-section-title"><i class="fas fa-file-alt"></i> Descripción profesional</h2>
          <div class="form-row">
            <div class="form-group">
              <label for="descripcion">Tu experiencia y especialidades</label>
              <textarea id="descripcion" name="descripcion" rows="4" maxlength="400"
                class="form-control descripcion-textarea" data-autoresize="true" autocomplete="off"
                placeholder="Cuentanos tu experiencia, herramientas y tipos de proyectos"><%= experto && experto.infoExperto && experto.infoExperto.descripcion ? experto.infoExperto.descripcion : '' %></textarea>
              <div class="char-counter"><span id="descContador">0</span>/400</div>
              <div class="mensaje-error" id="errorDescripcion"></div>
              <p class="form-hint">Sé concreto y destaca resultados</p>
            </div>
          </div>
        </div>

        <!-- Sección de categorías y días disponibles -->
        <div class="form-section">
          <h2 class="form-section-title"><i class="fas fa-tags"></i> Categorías y disponibilidad</h2>

          <!-- Sección de categorías -->
          <div class="form-row double">
            <div class="especializacion-container">
              <label for="selectCategorias" class="especializacion-label">Categorías de especialización</label>

              <% // Normalizar categorías seleccionadas (pueden venir como IDs, nombres o incluso objetos) const
                selectedCats=(experto && experto.infoExperto && Array.isArray(experto.infoExperto.categorias)) ?
                experto.infoExperto.categorias.map(function(c){ if (!c) return '' ; if (typeof c==='object' ) return
                String(c._id || c.id || c.value || c.nombre || '' ); return String(c); }) : []; %>

                <select id="selectCategorias" name="categorias[]" multiple class="selector-categorias"
                  aria-label="Categorías de especialización">
                  <% if (Array.isArray(categorias) && categorias.length) { categorias.forEach(function(cat) { const
                    catId=String(cat && (cat._id || cat.id || cat.value || cat.slug || cat.nombre || cat)); const
                    catNombre=(cat && (cat.nombre || cat.name || cat.titulo || cat.label)) ? (cat.nombre || cat.name ||
                    cat.titulo || cat.label) : catId; const isSelected=selectedCats.includes(catId) ||
                    selectedCats.includes(catNombre) || selectedCats.includes(catNombre.toLowerCase()); %>
                    <option value="<%= catId %>" <%=isSelected ? 'selected' : '' %>><%= catNombre %>
                    </option>
                    <% }); } else { %>
                      <option disabled>No hay categorías disponibles</option>
                      <% } %>
                </select>
                <div class="mensaje-error" id="errorCategorias"></div>
            </div>
          </div>
          <!-- Sección de días disponibles -->
          <div class="form-group">
            <label>Días disponibles</label>
            <div class="days-selector">
              <% var diasSemana=["Lunes", "Martes" , "Miércoles" , "Jueves" , "Viernes" , "Sábado" , "Domingo" ]; %>
                <% diasSemana.forEach(function(dia) { %>
                  <button type="button"
                    class="day-option<%= experto && experto.infoExperto && Array.isArray(experto.infoExperto.diasDisponibles) && experto.infoExperto.diasDisponibles.includes(dia) ? ' selected' : '' %>"
                    data-day="<%= dia %>">
                    <%= dia %>
                  </button>
                  <% }); %>
            </div>
            <input type="hidden" id="diasDisponibles" name="diasDisponibles"
              value="<%= experto && experto.infoExperto && Array.isArray(experto.infoExperto.diasDisponibles) ? experto.infoExperto.diasDisponibles.join(',') : '' %>">
            <div class="days-selected-display" id="diasDisplay">Selecciona tus días disponibles</div>
            <div class="input-error" id="errorDias"></div>
          </div>
        </div>

        <!-- Sección de datos bancarios -->
        <section class="form-section" aria-labelledby="bank-data-title">
          <header class="form-section-header">
            <h2 id="bank-data-title" class="form-section-title">
              <i class="fas fa-university" aria-hidden="true"></i>
              Datos bancarios
            </h2>
            <p class="form-section-description">
              Información requerida para realizar transferencias y pagos
            </p>
          </header>

          <!-- Formulario de datos bancarios y titular -->
          <div class="form-content">
            <div class="bank-data-grid">

              <!-- Información del banco -->
              <div class="form-field-group">
                <h4 class="form-subtitle">Información del banco</h4>
                <div class="form-row cols-4">

                  <!-- Banco (selector con búsqueda) -->
                  <div class="form-field">
                    <label for="banco" class="form-label">Banco</label>
                    <% const bancoActual=experto && experto.infoExperto && experto.infoExperto.banco ?
                      experto.infoExperto.banco : '' ; %>
                      <div class="select-wrapper">
                        <select id="banco" name="banco" class="form-control" aria-describedby="banco-hint">
                          <option value="">Selecciona tu banco</option>
                          <option value="Bancolombia" <%=bancoActual==='Bancolombia' ? 'selected' : '' %>>Bancolombia
                          </option>
                          <option value="Nequi" <%=bancoActual==='Nequi' ? 'selected' : '' %>>Nequi</option>
                        </select>
                        <i class="fas fa-chevron-down select-arrow" aria-hidden="true"></i>
                      </div>
                      <p class="form-hint" id="banco-hint">Selecciona el banco donde recibirás los pagos</p>
                      <div class="mensaje-error" id="errorBanco"></div>
                  </div>

                  <!-- Tipo de cuenta -->
                  <div class="form-field">
                    <label for="tipo-cuenta" class="form-label">Tipo de cuenta</label>
                    <% const tipoCuentaActual=experto && experto.infoExperto && experto.infoExperto.tipoCuenta ?
                      experto.infoExperto.tipoCuenta : '' ; %>
                      <div class="select-wrapper">
                        <select id="tipo-cuenta" name="tipoCuenta" class="form-control"
                          aria-describedby="tipo-cuenta-hint">
                          <option value="" <%=!tipoCuentaActual ? 'selected' : '' %>>Selecciona</option>
                          <option value="Ahorros" <%=tipoCuentaActual==='Ahorros' ? 'selected' : '' %>>Ahorros</option>
                          <option value="Corriente" <%=tipoCuentaActual==='Corriente' ? 'selected' : '' %>>Corriente
                          </option>
                          <option value="Nequi" <%=tipoCuentaActual==='Nequi' ? 'selected' : '' %>>Nequi</option>
                        </select>
                        <i class="fas fa-chevron-down select-arrow" aria-hidden="true"></i>
                      </div>
                      <p id="tipo-cuenta-hint" class="form-hint">Tipo de cuenta bancaria</p>
                      <div class="mensaje-error" id="errorTipoCuenta"></div>
                  </div>

                  <!-- Número de cuenta -->
                  <div class="form-field">
                    <label for="numeroCuenta" class="form-label">Número de cuenta</label>
                    <div class="password-wrapper">
                      <input type="text" id="numeroCuenta" name="numeroCuenta" placeholder="********" autocomplete="off"
                        class="form-control" aria-describedby="numero-cuenta-hint" maxlength="34" inputmode="numeric"
                        value="<%= experto && experto.infoExperto && experto.infoExperto.numeroCuenta ? experto.infoExperto.numeroCuenta : '' %>">
                      <button type="button" id="toggleAccountNumber" class="btn-icon"
                        aria-label="Mostrar/ocultar número de cuenta" aria-pressed="false">
                        <i class="fas fa-eye" aria-hidden="true"></i>
                      </button>
                    </div>
                    <p id="numero-cuenta-hint" class="form-hint">
                      <% if (bancoActual==='Nequi' ) { %>
                        Número de celular asociado a Nequi (10 dígitos).
                        <% } else if (bancoActual==='Bancolombia' ) { %>
                          Número de cuenta. Para bancos colombianos: 6–14 dígitos.
                          <% } else { %>
                            Número de cuenta o identificación asociado a la cuenta. Para bancos colombianos: 6–14
                            dígitos. Para cuentas internacionales: 15–34 caracteres alfanuméricos.
                            <% } %>
                    </p>
                    <div class="mensaje-error" id="errorNumeroCuenta"></div>
                  </div>

                </div>
              </div>
            </div>

            <!-- Información del titular -->
            <div class="form-field-group">
              <h4 class="form-subtitle">Información del titular</h4>
              <div class="form-row cols-4">
                <!-- Nombre del titular -->
                <div class="form-field">
                  <label for="titular" class="form-label">Nombre completo</label>
                  <input type="text" id="titular" name="titular" placeholder="Nombre del titular" class="form-control"
                    aria-describedby="titular-hint"
                    value="<%= experto && experto.infoExperto && experto.infoExperto.titular ? experto.infoExperto.titular : '' %>">
                  <p id="titular-hint" class="form-hint">Nombre tal como aparece en la cuenta</p>
                  <div class="mensaje-error" id="errorTitular"></div>
                </div>

                <!-- Tipo de documento -->
                <div class="form-field">
                  <label for="tipo-documento" class="form-label">Tipo de documento</label>
                  <div class="select-wrapper">
                    <% const tipoDocActual=experto && experto.infoExperto && experto.infoExperto.tipoDocumento ?
                      experto.infoExperto.tipoDocumento : '' ;%>
                      <select id="tipo-documento" name="tipoDocumento" class="form-control">
                        <option value="" <%=!tipoDocActual ? 'selected' : '' %>>Selecciona</option>
                        <option value="CC" <%=tipoDocActual==='CC' ? 'selected' : '' %>>Cédula</option>
                        <option value="CE" <%=tipoDocActual==='CE' ? 'selected' : '' %>>Cédula de extranjería</option>
                        <option value="NIT" <%=tipoDocActual==='NIT' ? 'selected' : '' %>>NIT</option>
                      </select>
                      <i class="fas fa-chevron-down select-arrow" aria-hidden="true"></i>
                  </div>
                  <div class="mensaje-error" id="errorTipoDocumento"></div>
                </div>

                <!-- Número de documento con toggle -->
                <div class="form-field">
                  <label for="numero-documento" class="form-label">Número de documento</label>
                  <div class="password-wrapper">
                    <!-- Este campo no es una contraseña; usar type="text" evita que el gestor de contraseñas aparezca -->
                    <input type="text" id="numero-documento" name="numeroDocumento" placeholder="Ej: 3004888442"
                      autocomplete="off" class="form-control" aria-describedby="numero-documento-hint"
                      inputmode="numeric" maxlength="11"
                      value="<%= experto && experto.infoExperto && experto.infoExperto.numeroDocumento ? experto.infoExperto.numeroDocumento : '' %>">
                    <button type="button" id="toggleDocumentoNumber" class="btn-icon"
                      aria-label="Mostrar número de documento" aria-pressed="false">
                      <i class="fas fa-eye" aria-hidden="true"></i>
                    </button>
                  </div>
                  <p id="numero-documento-hint" class="form-hint">Sin puntos ni espacios</p>
                  <div class="mensaje-error" id="errorNumeroDocumento"></div>
                </div>
              </div>
            </div>
          </div>
          </div>

          <!-- Botón de enviar -->
          <div class="form-actions">
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-save"></i> Guardar cambios
            </button>
          </div>

      </form>
    </section>
  </main>
  <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
  <script src="/assets/js/shared-validators.umd.js"></script>
  <script src="/assets/js/editarExperto.js"></script>

</body>

</html>
