<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mi Perfil | Servitech</title>
  <link rel="stylesheet" href="/assets/css/base.css" />
  <link rel="stylesheet" href="/assets/css/perfil.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
</head>

<body>
  <main class="container">
    <% if (typeof error !=='undefined' && error) { %>
      <div class="alert alert-danger" style="margin-bottom: 1rem;">
        <%= error %>
      </div>
      <% } %>
        <section class="perfil-section">
          <h1 class="perfil-title">Mi Perfil</h1>
          <div class="perfil-card">
            <!-- imagen de perfil -->
            <div class="perfil-avatar">
              <% let avatarSrc='/assets/img/default-avatar.png' ; if (user && (user.avatar || user.avatarUrl)) {
                avatarSrc=user.avatar || user.avatarUrl; try { if (typeof avatarSrc==='string' &&
                avatarSrc.indexOf('http://localhost:5021/uploads')===0) {
                avatarSrc=avatarSrc.replace('http://localhost:5021','http://localhost:5020'); } } catch (e) {} } %>
                <img src="<%= avatarSrc %>" alt="Avatar de Usuario" id="profileAvatar">
                <button class="change-avatar-btn">
                  <i class="fas fa-camera"></i>
                </button>
            </div>
            <!-- Información básica y acciones -->
            <div class="perfil-info">
              <h2 id="userName">
                <%= user ? (user.nombre || 'Sin nombre' ) : 'No autenticado' %>
              </h2>
              <p id="userEmail">
                <%= user ? (user.email || 'Sin email' ) : '' %>
              </p>
              <div class="perfil-actions">
                <% if (user && user.roles && user.roles.includes('experto')) { %>
                  <a href="/editarExperto" id="btnEditarPerfil" class="btn btn-primary">
                    <i class="fas fa-edit"></i> Editar datos de experto
                  </a>
                  <% } %>
                    <a href="/misAsesorias.html" class="btn btn-outline">
                      <i class="fas fa-calendar-alt"></i> Mis asesorías
                    </a>
                    <a href="/" class="btn btn-secondary" style="margin-left: 1rem;">
                      <i class="fas fa-arrow-left"></i> Volver al inicio
                    </a>
              </div>
            </div>
          </div>

          <div class="profile-main">
            <div class="profile-tab" id="personalInfo">
              <div style="display:flex;align-items:center;justify-content:space-between;">
                <h2>Información personal</h2>
                <% if (user) { %>
                  <a href="#" id="btnEditarNombreApellido" class="btn btn-secondary btn-sm">
                    <i class="fas fa-edit"></i> Editar nombre y apellido
                  </a>
                  <% } %>
              </div>
              <form class="profile-form">
                <div class="form-row">
                  <div class="form-group">
                    <label for="firstName">Nombre</label>
                    <input type="text" id="firstName" value="<%= user ? user.nombre : '' %>" placeholder="Tu nombre"
                      disabled>
                  </div>
                  <div class="form-group">
                    <label for="lastName">Apellido</label>
                    <input type="text" id="lastName" value="<%= user ? user.apellido : '' %>" placeholder="Tu apellido"
                      disabled>
                  </div>
                </div>
                <div class="form-group">
                  <label for="formEmail">Email</label>
                  <input type="email" id="formEmail" value="<%= user ? user.email : '' %>"
                    placeholder="tucorreo@ejemplo.com" disabled>
                </div>
              </form>
            </div>
            <% if (user && user.roles && user.roles.includes('experto') && user.infoExperto) { %>
              <div class="profile-tab" id="expertInfo">
                <h2>Información de Experto</h2>
                <!-- ... El resto igual que ya tienes ... -->
              </div>
              <% } else if (user && user.roles && user.roles.includes('experto') && !user.infoExperto) { %>
                <div class="profile-tab" id="expertInfo">
                  <div class="alert alert-warning">
                    <strong>¡Atención!</strong> Tu perfil de experto está incompleto.
                    <a href="/registroExperto">Completa tu información aquí</a>.
                  </div>
                </div>
                <% } else if (user && user.roles && !user.roles.includes('experto')) { %>
                  <div class="profile-tab" id="expertInfo">
                    <div class="alert alert-info">
                      ¿Quieres convertirte en experto?
                      <a href="/registroExperto">Regístrate como experto aquí</a>.
                    </div>
                  </div>
                  <% } %>
          </div>
        </section>
  </main>
  <!-- Modal edición nombre y apellido -->
  <section class="modal-section *:hidden" id="modalSection">
    <div id="modalEditarNombreApellido" class="modal-perfil" style="display:none;">
      <div class="modal-content-perfil">
        <h3>Editar nombre y apellido</h3>
        <form id="formEditarNombreApellido" autocomplete="off">
          <div class="form-row">
            <div class="form-group">
              <label for="modalFirstName">Nombre</label>
              <input type="text" id="modalFirstName" maxlength="80" required>
              <div class="input-error" id="errorNombre"></div>
            </div>
            <div class="form-group">
              <label for="modalLastName">Apellido</label>
              <input type="text" id="modalLastName" maxlength="80" required>
              <div class="input-error" id="errorApellido"></div>
            </div>
          </div>
          <div class="modal-btns">
            <button type="button" class="btn btn-secondary" id="btnCancelarModal">Cancelar</button>
            <button type="submit" class="btn btn-primary">Guardar</button>
          </div>
          <div class="input-error" id="modalErrorGeneral"></div>
        </form>
      </div>
    </div>
  </section>
</body>
<script src="/assets/js/common.js"></script>
<script src="/assets/js/index.js"></script>
<script src="/assets/js/perfil.js"></script>
</body>

</html>
