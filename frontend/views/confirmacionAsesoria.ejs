<!DOCTYPE html>
<!--
  Archivo: confirmacionAsesoria.ejs
  Propósito: Mostrar confirmación y resumen tras el pago/agenda de una asesoría.
  Variables EJS esperadas:
    - status: 'success'|'pending'|'failed' (opcional)
    - asesoria: objeto con información de la asesoría (opcional)
    - pago: objeto con información del pago (opcional)
  Dependencias:
    - /assets/css/confirmacion-asesoria.css, /assets/js/confirmacionAsesoria.js
  Notas para Deepwiki:
    - No incluir números de tarjeta completos; mostrar solo últimos 4 dígitos si es necesario.
    - Esta vista se usa como punto de aterrizaje tras procesos de pago.
-->

<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>
    <% if (typeof status !=='undefined' && status==='success' ) { %>
      ¡Pago Confirmado! - ServiTech
      <% } else if (typeof status !=='undefined' && status==='pending' ) { %>
        Procesando Pago - ServiTech
        <% } else { %>
          Confirmación de Pago - ServiTech
          <% } %>
  </title>
  <link rel="stylesheet" href="/assets/css/base.css">
  <link rel="stylesheet" href="/assets/css/confirmacion-asesoria.css">
  <meta name="description" content="Confirmación y resumen de tu pago en ServiTech">
  <meta name="robots" content="noindex, nofollow">
</head>

<body>
  <main>
    <div class="container">
      <section class="confirmacionCard success">
        <div class="iconContainer">
          <i class="fas fa-check-circle"></i>
        </div>
        <div class="top-actions">
          <button id="btnReenviarNoti" class="btn btn-outline hidden">Reenviar notificaciones</button>
        </div>
        <h1>¡Asesoría agendada exitosamente!</h1>
        <p class="mensajePrincipal">
          Tu pago fue procesado. La solicitud fue enviada al experto.
          El dinero está retenido hasta que se complete la asesoría.
        </p>

        <!-- Factura/Resumen de pago y asesoría -->
        <div class="facturaContainer">

          <h3><i class="fas fa-file-invoice"></i> Resumen de tu solicitud y factura</h3>
          <div class="facturaGrid">
            <!-- Datos de la asesoría -->
            <div class="facturaSection">
              <h4>Datos de la asesoría</h4>
              <% if (typeof asesoria !=='undefined' && asesoria) { %>
                <div class="summary-box">
                  <div class="summary-item">
                    <div class="item-label"><strong>Título:</strong></div>
                    <div class="item-value descripcion">
                      <%= asesoria.titulo %>
                    </div>
                  </div>
                  <div class="summary-item">
                    <div class="item-label"><strong>Descripción:</strong></div>
                    <div class="item-value descripcion">
                      <%= asesoria.descripcion %>
                    </div>
                  </div>
                  <div class="summary-item">
                    <div class="item-label"><strong>Fecha y hora:</strong></div>
                    <div class="item-value descripcion">
                      <%= asesoria.fechaHoraInicio ? new Date(asesoria.fechaHoraInicio).toLocaleString('es-CO') : 'N/A'
                        %>
                    </div>
                  </div>
                  <div class="summary-item">
                    <div class="item-label"><strong>Duración:</strong></div>
                    <div class="item-value descripcion">
                      <%= asesoria.duracionMinutos %> minutos
                    </div>
                  </div>
                  <div class="summary-item">
                    <div class="item-label"><strong>Cliente:</strong></div>
                    <div class="item-value descripcion">
                      <%= asesoria.cliente?.nombre %>
                        <%= asesoria.cliente?.apellido %> (<%= asesoria.cliente?.email %>)
                    </div>
                  </div>
                  <div class="summary-item">
                    <div class="item-label"><strong>Experto:</strong></div>
                    <div class="item-value descripcion">
                      <%= asesoria.experto?.nombre %>
                        <%= asesoria.experto?.apellido %> (<%= asesoria.experto?.email %>)
                    </div>
                  </div>
                </div>
                <% } else { %>
                  <p>No se encontraron datos de la asesoría.</p>
                  <% } %>
            </div>

            <!-- Datos del pago -->
            <div class="facturaSection">
              <h4>Datos de pago / Factura</h4>
              <% if (typeof pago !=='undefined' && pago && pago.metadatos && pago.metadatos.datosPago) { %>
                <div class="summary-box">
                  <div class="summary-item">
                    <div class="item-label"><strong>Nombre:</strong></div>
                    <div class="item-value descripcion">
                      <%= pago.metadatos.datosPago.nombre %>
                    </div>
                  </div>
                  <div class="summary-item">
                    <div class="item-label"><strong>Email:</strong></div>
                    <div class="item-value descripcion">
                      <%= pago.metadatos.datosPago.email %>
                    </div>
                  </div>
                  <% if (pago.metadatos.datosPago.telefono) { %>
                    <div class="summary-item">
                      <div class="item-label"><strong>Teléfono:</strong></div>
                      <div class="item-value descripcion">
                        <%= pago.metadatos.datosPago.telefono %>
                      </div>
                    </div>
                    <% } %>
                      <div class="summary-item">
                        <div class="item-label"><strong>Monto:</strong></div>
                        <div class="item-value descripcion">$<%= pago.monto ? pago.monto.toLocaleString('es-CO') : 'N/A'
                            %> COP</div>
                      </div>
                      <div class="summary-item">
                        <div class="item-label"><strong>Método:</strong></div>
                        <div class="item-value descripcion">
                          <%= pago.metadatos.datosPago.metodo==='tarjeta' ? 'Tarjeta de crédito/débito' :
                            (pago.metadatos.datosPago.metodo==='pse' ? 'PSE (simulado)' : (pago.metodo || 'Simulado' ))
                            %>
                        </div>
                      </div>
                      <% if (pago.metadatos.datosPago.metodo==='tarjeta' ) { %>
                        <div class="summary-item">
                          <div class="item-label"><strong>Número de tarjeta:</strong></div>
                          <div class="item-value descripcion">**** **** **** <%= pago.metadatos.datosPago.numeroTarjeta
                              ? pago.metadatos.datosPago.numeroTarjeta.slice(-4) : 'XXXX' %>
                          </div>
                        </div>
                        <div class="summary-item">
                          <div class="item-label"><strong>Expiración:</strong></div>
                          <div class="item-value descripcion">
                            <%= pago.metadatos.datosPago.expiracionTarjeta %>
                          </div>
                        </div>
                        <% } %>
                          <div class="summary-item">
                            <div class="item-label"><strong>Fecha del pago:</strong></div>
                            <div class="item-value descripcion">
                              <%= pago.fechaCreacion ? new Date(pago.fechaCreacion).toLocaleString('es-CO') : 'N/A' %>
                            </div>
                          </div>
                </div>
                <% } else { %>
                  <p>No se encontraron datos del pago.</p>
                  <% } %>
            </div>
          </div>
        </div>
        <!-- Pasos siguientes (¿Qué sigue ahora?) -->
        <section class="pasosSiguientes">
          <h3>¿Qué sigue ahora?</h3>
          <div class="pasoPago">
            <div class="pasoNumero">1</div>
            <div class="pasoContenido">
              <h4>El experto revisa tu solicitud</h4>
              <p>El experto tiene hasta 24 horas para aceptar o rechazar tu solicitud.</p>
            </div>
          </div>
          <div class="pasoPago">
            <div class="pasoNumero">2</div>
            <div class="pasoContenido">
              <h4>Recibe notificación</h4>
              <p>Te avisaremos por email cuando el experto responda.</p>
            </div>
          </div>
          <div class="pasoPago">
            <div class="pasoNumero">3</div>
            <div class="pasoContenido">
              <h4>Coordina la asesoría</h4>
              <p>Si es aceptada, recibirás los datos de contacto para la videollamada.</p>
            </div>
          </div>

          <div class="accionesPago" style="margin-top:18px;">
            <a href="/" class="btn btn-secondary">Ir al inicio</a>
            <a href="/misAsesorias.html" class="btn btn-primary">Ver mis asesorías</a>
            <a href="/expertos.html" class="btn btn-secondary">Buscar más expertos</a>
          </div>
        </section>
      </section>
    </div>
  </main>

  <!-- Datos para JS -->
  <script type="application/json" id="pageStatus"><%- JSON.stringify(status) %></script>
  <script type="application/json" id="pageData"><%- JSON.stringify({
    pagoId: typeof pagoId !== 'undefined' ? pagoId : null,
    asesoriaId: typeof asesoriaId !== 'undefined' ? asesoriaId : null,
    simulado: true,
    hasUser: !!(user)
  }) %></script>
  <script type="application/json" id="facturaData"><%- JSON.stringify({
    pago: typeof pago !== 'undefined' ? pago : null,
    asesoria: typeof asesoria !== 'undefined' ? asesoria : null
  }) %></script>
  <script src="/assets/js/common.js"></script>
  <script src="/assets/js/confirmacionAsesoria.js"></script>

  <div id="conexionEstado" class="conexion-estado offline" style="display: none;">
    <i class="fas fa-wifi-slash"></i> <span>Sin conexión</span>
  </div>
</body>

</html>
