<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gestión de Expertos - Servitech Admin</title>
  <link rel="stylesheet" href="/assets/css/administrador.css" />
  <link rel="stylesheet" href="/assets/css/admin.css" />
  <link rel="stylesheet" href="/assets/css/admin-responsive.css" />
  <link rel="stylesheet" href="/assets/css/admin-components.css" />
  <!-- page-specific CSS -->
  <link rel="stylesheet" href="/assets/css/Admin-expertos.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />

  <!-- Choices.js CSS para campos de selección múltiple -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js@10.2.0/public/assets/styles/choices.min.css" />
</head>

<body>

  <!-- Layout general de admin -->
  <div class="admin-layout">
    <%- include('../componentes/navbarAdmin.ejs') %>

      <script id="initial-expertos" type="application/json"><%= JSON.stringify(initialExpertos || []) %></script>

      <main class="admin-main">
        <!-- Contenido principal -->
        <header class="admin-header">
          <div class="admin-content-wrapper">
            <div class="header-search">
              <i class="fas fa-search"></i>
              <input type="text" placeholder="Buscar expertos..." />
            </div>
            <div class="header-actions">
              <div class="notification-icon">
                <i class="fas fa-bell"></i>
                <span class="notification-badge">5</span>
              </div>
              <div class="admin-profile">
                <img src="https://i.pravatar.cc/150?img=11" alt="Admin profile" class="profile-img" />
                <div class="profile-info">
                  <span class="profile-name">Admin ServiTech</span>
                  <span class="profile-role">Administrador</span>
                </div>
                <i class="fas fa-chevron-down"></i>
              </div>
            </div>
          </div>
        </header>

        <div class="admin-content">

          <!-- Título y acciones principales. -->
          <div class="page-header">
            <h1>Gestión de Expertos</h1>
            <div class="page-actions">
              <button type="button" class="btn-primary" id="btnAddExpert">
                <i class="fas fa-plus"></i>
                <span>Nuevo experto</span>
              </button>
              <button class="btn-outline">
                <i class="fas fa-file-export"></i>
                <span>Exportar</span>
              </button>
            </div>
          </div>

          <!-- (styles and grid/table markup unchanged, omitted here for brevity but preserved) -->
          <style>
            :root {
              --admin-bg: #0e1525;
              --admin-card-bg: #1c2333;
              --admin-border-color: #2b3245;
              --admin-hover-bg: #252e43;
              --admin-accent-color: #3a8eff;
              --admin-accent-secondary: #12d8fa;
              --admin-text-primary: #f5f5f5;
              --admin-text-secondary: #a0a0a0;
              --admin-shadow: 0 4px 12px #00000040;
            }

            /* Layout */
            .expertos-grid {
              display: grid;
              grid-template-columns: 320px 1fr;
              gap: 20px;
              align-items: start;
              width: 100%;
              box-sizing: border-box;
            }

            .expertos-card {
              background: var(--admin-card-bg);
              border: 1px solid var(--admin-border-color);
              border-radius: 12px;
              padding: 16px;
              box-shadow: var(--admin-shadow);
              color: var(--admin-text-primary);
            }

            /* Filters (aside) */
            .expertos-grid__filters {
              display: flex;
              flex-direction: column;
              gap: 16px;
            }

            .expertos-filtros__title {
              margin: 0 0 6px 0;
              font-size: 1.05rem;
              color: var(--admin-text-primary);
              font-weight: 600;
            }

            .expertos-filtros__group {
              display: flex;
              flex-direction: column;
              gap: 8px;
            }

            .expertos-filtros__label {
              font-size: 0.88rem;
              color: var(--admin-text-secondary);
            }

            .expertos-filtros__select {
              appearance: none;
              -webkit-appearance: none;
              background: rgba(255, 255, 255, 0.02);
              color: var(--admin-text-primary);
              border: 1px solid var(--admin-border-color);
              padding: 8px 10px;
              border-radius: 8px;
              font-size: 0.95rem;
              outline: none;
              transition: box-shadow .12s ease, border-color .12s ease;
            }

            .expertos-filtros__select:focus {
              border-color: var(--admin-accent-color);
              box-shadow: 0 0 0 6px rgba(58, 142, 255, 0.06);
            }

            .expertos-filtros__btn,
            .expertos-filtros__reset {
              display: inline-flex;
              align-items: center;
              gap: 8px;
              justify-content: center;
              width: 100%;
              padding: 10px 12px;
              border-radius: 8px;
              font-weight: 600;
              cursor: pointer;
              border: 0;
              transition: transform .06s ease, box-shadow .12s ease, background .12s ease;
            }

            .expertos-filtros__btn {
              background: linear-gradient(180deg, var(--admin-accent-color), var(--admin-accent-color));
              color: #fff;
              box-shadow: 0 6px 18px rgba(58, 142, 255, 0.12);
            }

            .expertos-filtros__btn:hover {
              transform: translateY(-1px);
            }

            .expertos-filtros__reset {
              background: transparent;
              border: 1px solid var(--admin-border-color);
              color: var(--admin-text-secondary);
            }

            .expertos-filtros__reset:hover {
              color: var(--admin-text-primary);
              background: rgba(255, 255, 255, 0.02);
            }

            /* Statistics block */
            .expertos-estadisticas__title {
              margin: 0 0 8px 0;
              font-size: 1.05rem;
              color: var(--admin-text-primary);
              font-weight: 600;
            }

            .expertos-estadisticas__list {
              display: grid;
              gap: 10px;
            }

            .expertos-estadisticas__item {
              display: flex;
              align-items: center;
              justify-content: space-between;
              background: transparent;
              padding: 10px;
              border-radius: 8px;
              border: 1px solid rgba(255, 255, 255, 0.02);
            }

            .expertos-estadisticas__item-info {
              display: flex;
              gap: 8px;
              align-items: center;
              color: var(--admin-text-secondary);
              font-size: 0.95rem;
            }

            .expertos-estadisticas__icon {
              color: var(--admin-accent-color);
              width: 20px;
              height: 20px;
            }

            .expertos-estadisticas__value {
              font-weight: 700;
              color: var(--admin-text-primary);
              font-size: 0.98rem;
            }

            /* Table area */
            .expertos-grid__tabla {
              padding: 12px;
            }

            .table-wrap {
              overflow: auto;
              border-radius: 10px;
            }

            .admin-table {
              width: 100%;
              border-collapse: collapse;
              min-width: 820px;
              color: var(--admin-text-primary);
              background: transparent;
            }

            .admin-table thead th {
              text-align: left;
              font-size: 0.9rem;
              color: var(--admin-text-secondary);
              padding: 12px 14px;
              border-bottom: 1px solid var(--admin-border-color);
              vertical-align: middle;
            }

            .admin-table tbody td {
              padding: 12px 14px;
              vertical-align: middle;
              border-bottom: 1px dashed rgba(255, 255, 255, 0.03);
              font-size: 0.95rem;
              color: var(--admin-text-primary);
            }

            .admin-table tbody tr:hover td {
              background: var(--admin-hover-bg);
            }

            .admin-table .expertos-checkbox {
              width: 16px;
              height: 16px;
              accent-color: var(--admin-accent-color);
            }

            .admin-table img.profile-img {
              width: 40px;
              height: 40px;
              border-radius: 8px;
              object-fit: cover;
              margin-right: 8px;
            }

            /* Actions cell */
            .admin-table td .action-btn {
              display: inline-flex;
              align-items: center;
              gap: 8px;
              padding: 6px 8px;
              border-radius: 8px;
              font-size: 0.9rem;
              cursor: pointer;
              border: 1px solid transparent;
              transition: background .12s ease, transform .06s ease;
            }

            .admin-table td .action-btn:hover {
              transform: translateY(-1px);
            }

            .admin-table td .btn-view {
              background: rgba(58, 142, 255, 0.12);
              color: var(--admin-text-primary);
              border-color: rgba(58, 142, 255, 0.12);
            }

            .admin-table td .btn-edit {
              background: rgba(18, 216, 250, 0.06);
              color: var(--admin-text-primary);
              border-color: rgba(18, 216, 250, 0.06);
            }

            .admin-table td .btn-disable {
              background: transparent;
              color: var(--admin-text-secondary);
              border-color: rgba(255, 255, 255, 0.02);
            }

            /* Placeholder row */
            .placeholder-row td {
              background: transparent;
            }

            /* Pagination */
            .expertos-paginacion {
              display: flex;
              align-items: center;
              justify-content: space-between;
              margin-top: 12px;
              gap: 12px;
              color: var(--admin-text-secondary);
              font-size: 0.92rem;
            }

            .expertos-paginacion__controles {
              display: inline-flex;
              gap: 6px;
              align-items: center;
            }

            .expertos-paginacion__btn {
              background: transparent;
              border: 1px solid var(--admin-border-color);
              color: var(--admin-text-primary);
              padding: 8px 10px;
              border-radius: 8px;
              cursor: pointer;
              min-width: 38px;
            }

            .expertos-paginacion__btn--active {
              background: linear-gradient(180deg, var(--admin-accent-color), var(--admin-accent-color));
              color: #fff;
              border-color: transparent;
            }

            .expertos-paginacion__btn--disabled,
            .expertos-paginacion__btn[aria-disabled="true"] {
              opacity: 0.5;
              cursor: default;
            }

            .expertos-paginacion__ellipsis {
              color: var(--admin-text-secondary);
              padding: 0 6px;
            }

            /* Responsive */
            @media (max-width: 980px) {
              .expertos-grid {
                grid-template-columns: 1fr;
              }

              .admin-table {
                min-width: 720px;
              }
            }

            @media (max-width: 640px) {
              .admin-table {
                min-width: 600px;
                font-size: 0.92rem;
              }

              .expertos-filtros__btn,
              .expertos-filtros__reset {
                padding: 10px;
              }
            }
          </style>

          <div class="expertos-grid">
            <aside class="expertos-card expertos-grid__filters" aria-label="Filtros y estadísticas">
              <div class="expertos-filtros">
                <h3 class="expertos-filtros__title">Filtros</h3>

                <div class="expertos-filtros__group">
                  <label class="expertos-filtros__label" for="filterEstado">Estado</label>
                  <select class="expertos-filtros__select" id="filterEstado">
                    <option value="">Todos los estados</option>
                    <option value="active">Activos</option>
                    <option value="pending">Pendientes</option>
                    <option value="inactive">Inactivos</option>
                  </select>
                </div>

                <div class="expertos-filtros__group">
                  <label class="expertos-filtros__label" for="filterCategoria">Categoría</label>
                  <select class="expertos-filtros__select" id="filterCategoria">
                    <option value="">Todas las categorías</option>
                    <% if (typeof categorias !=='undefined' && Array.isArray(categorias)) { %>
                      <% categorias.forEach(function(c){ %>
                        <option value="<%= c._id %>">
                          <%= c.nombre || c.name %>
                        </option>
                        <% }) %>
                          <% } %>
                  </select>
                </div>

                <div class="expertos-filtros__group">
                  <label class="expertos-filtros__label" for="filterRating">Calificación mínima</label>
                  <select class="expertos-filtros__select" id="filterRating">
                    <option value="">Todas las calificaciones</option>
                    <option value="5">5 estrellas</option>
                    <option value="4">4+ estrellas</option>
                    <option value="3">3+ estrellas</option>
                    <option value="2">2+ estrellas</option>
                  </select>
                </div>

                <button class="btn-primary expertos-filtros__btn" id="applyFiltersBtn">
                  <i class="fas fa-filter" aria-hidden="true"></i>
                  <span>Aplicar filtros</span>
                </button>

                <button type="button" class="btn-outline expertos-filtros__reset" id="resetFiltersBtn"
                  aria-label="Limpiar filtros">
                  <i class="fas fa-eraser" aria-hidden="true"></i>
                  <span>Limpiar filtros</span>
                </button>
              </div>

              <div class="expertos-estadisticas" style="margin-top:1rem;">
                <h3 class="expertos-estadisticas__title">Estadísticas</h3>
                <div class="expertos-estadisticas__list">
                  <div class="expertos-estadisticas__item">
                    <div class="expertos-estadisticas__item-info">
                      <i class="fas fa-user-tie expertos-estadisticas__icon" aria-hidden="true"></i>
                      <span>Total Expertos</span>
                    </div>
                    <span class="expertos-estadisticas__value">128</span>
                  </div>
                  <div class="expertos-estadisticas__item">
                    <div class="expertos-estadisticas__item-info">
                      <i class="fas fa-check-circle expertos-estadisticas__icon" aria-hidden="true"></i>
                      <span>Activos</span>
                    </div>
                    <span class="expertos-estadisticas__value">98</span>
                  </div>
                  <div class="expertos-estadisticas__item">
                    <div class="expertos-estadisticas__item-info">
                      <i class="fas fa-clock expertos-estadisticas__icon" aria-hidden="true"></i>
                      <span>Pendientes</span>
                    </div>
                    <span class="expertos-estadisticas__value">22</span>
                  </div>
                  <div class="expertos-estadisticas__item">
                    <div class="expertos-estadisticas__item-info">
                      <i class="fas fa-star expertos-estadisticas__icon" aria-hidden="true"></i>
                      <span>Promedio</span>
                    </div>
                    <span class="expertos-estadisticas__value">4.7</span>
                  </div>
                </div>
              </div>
            </aside>

            <section class="expertos-card expertos-grid__tabla" aria-label="Tabla de expertos">
              <div class="table-wrap">
                <table class="admin-table" role="table" aria-label="Lista de expertos">
                  <thead>
                    <tr>
                      <th style="width:40px;">
                        <input type="checkbox" id="selectAll" class="expertos-checkbox" />
                      </th>
                      <th>Experto</th>
                      <th>Categorías</th>
                      <th>Especialidad</th>
                      <th>Registro</th>
                      <th>Sesiones</th>
                      <th>Calificación</th>
                      <th>Estado</th>
                      <th style="width:160px;">Acciones</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr class="placeholder-row">
                      <td colspan="9" style="text-align:center;padding:24px;color:var(--admin-text-secondary);">
                        Cargando expertos...
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>

              <div class="expertos-paginacion" role="navigation" aria-label="Paginación de expertos">
                <span class="expertos-paginacion__info">Mostrando 1-7 de 128 expertos</span>
                <div class="expertos-paginacion__controles" aria-hidden="false">
                  <button class="expertos-paginacion__btn expertos-paginacion__btn--disabled" aria-disabled="true">
                    <i class="fas fa-chevron-left" aria-hidden="true"></i>
                  </button>
                  <button class="expertos-paginacion__btn expertos-paginacion__btn--active"
                    aria-current="page">1</button>
                  <button class="expertos-paginacion__btn">2</button>
                  <button class="expertos-paginacion__btn">3</button>
                  <span class="expertos-paginacion__ellipsis">…</span>
                  <button class="expertos-paginacion__btn">18</button>
                  <button class="expertos-paginacion__btn">
                    <i class="fas fa-chevron-right" aria-hidden="true"></i>
                  </button>
                </div>
              </div>
            </section>
          </div>
        </div>
      </main>
  </div>

  <!-- CSS Modal para agregar experto -->
  <style>
    /* Recuadro contenedor para selects de categorías (antes/después de Choices) */
    .modal-expert .choices-container {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.03));
      border: 1px solid rgba(94, 129, 255, 0.2);
      border-radius: 12px;
      padding: 0.75rem 1rem;
      min-height: 52px;
      display: block;
      width: 100%;
      box-sizing: border-box;
      box-shadow: 0 4px 16px rgba(2, 6, 23, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.1);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .modal-expert .choices-container:hover {
      border-color: rgba(94, 129, 255, 0.4);
      box-shadow: 0 8px 24px rgba(2, 6, 23, 0.4), 0 0 0 1px rgba(94, 129, 255, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.15);
      transform: translateY(-1px);
    }

    .modal-expert .choices-container:focus-within {
      border-color: var(--admin-accent-color, #5e81ff);
      box-shadow: 0 8px 32px rgba(94, 129, 255, 0.3), 0 0 0 3px rgba(94, 129, 255, 0.15), inset 0 1px 0 rgba(255, 255, 255, 0.2);
      transform: translateY(-2px);
    }

    /* Asegurar que el select interno ocupe todo y no rompa el layout antes de Choices */
    .modal-expert .choices-container>select.modal-expert__select-categorias {
      width: 100% !important;
      background: transparent !important;
      border: none !important;
      outline: none !important;
      box-shadow: none !important;
      appearance: none !important;
      -webkit-appearance: none !important;
      -moz-appearance: none !important;
      background-image: none !important;
      color: var(--admin-text-primary) !important;
      padding: 0 !important;
      min-height: 32px !important;
      font-size: 0.95rem !important;
      border-radius: 0 !important;
    }

    /* Regla global por si el select de categorías no está envuelto (editar/ver) */
    .modal-expert select.modal-expert__select-categorias {
      border: 0 !important;
      outline: 0 !important;
      box-shadow: none !important;
      appearance: none !important;
      -webkit-appearance: none !important;
      -moz-appearance: none !important;
      background: transparent !important;
      background-image: none !important;
      border-radius: 0 !important;
    }

    /* Cuando Choices ya está montado, el recuadro queda como wrapper visual */
    .modal-expert .choices-container .choices {
      margin-top: 0 !important;
    }

    /* Evitar estados visuales del inner dentro del wrapper (categorías) */
    .modal-expert .choices-container .choices .choices__inner:hover,
    .modal-expert .choices-container .choices .choices__inner:focus-within {
      border-color: transparent !important;
      box-shadow: none !important;
      transform: none !important;
    }

    /* Modal overlay & container (apply to any .modal-expert instance) */
    .modal-expert {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(2, 6, 23, 0.6);
      z-index: 1200;
      -webkit-overflow-scrolling: touch;
      padding: 28px;
      box-sizing: border-box;
    }

    .modal-expert .modal-expert__container {
      width: 100%;
      max-width: min(980px, calc(100% - 56px));
      max-height: calc(100vh - 56px);
      margin: 0 auto;
      box-sizing: border-box;
      background: var(--admin-card-bg);
      border: 0;
      border-radius: 12px;
      box-shadow: var(--admin-shadow);
      color: #f8fafc;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      padding: 20px;
    }

    .modal-expert,
    .modal-expert * {
      pointer-events: auto !important;
    }

    .modal-expert .modal-expert__container {
      position: relative;
      z-index: 1220;
    }

    .modal-expert .btn-close {
      position: relative;
      z-index: 1230;
    }

    /* Header */
    .modal-expert .modal-expert__header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1rem 1.125rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.03), transparent);
    }

    .modal-expert .modal-expert__title {
      margin: 0;
      font-size: 1.125rem;
      font-weight: 600;
      color: #f1f5f9;
    }

    .modal-expert .btn-close {
      background: transparent;
      color: #cbd5e1;
      width: 40px;
      height: 40px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      cursor: pointer;
      transition: background .12s ease, color .12s ease;
    }

    .modal-expert .btn-close:hover {
      background: rgba(255, 255, 255, 0.05);
      color: #f8fafc;
    }

    /* Body (scrollable) */
    .modal-expert .modal-expert__body {
      padding: 1rem;
      overflow: auto;
      flex: 1 1 auto;
    }

    /* Form grid - OPTIMIZADO para mejor organización visual */
    .modal-expert .modal-expert__grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 1.5rem;
      align-items: start;
      width: 100%;
      box-sizing: border-box;
      margin-bottom: 2rem;
    }

    .modal-expert .modal-expert__grid .full-width {
      grid-column: 1 / -1;
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid rgba(255, 255, 255, 0.08);
    }

    .modal-expert .modal-expert__grid .full-width:first-child {
      margin-top: 0;
      padding-top: 0;
      border-top: none;
    }

    /* Grid items - contenedores de campos individuales */
    .modal-expert .modal-expert__grid>div {
      display: flex;
      flex-direction: column;
      min-height: fit-content;
    }

    /* Labels and inputs - MODIFICADO para mejor organización */
    .modal-expert .modal-expert__label {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.9rem;
      color: #e2e8f0;
      margin-bottom: 0.5rem;
      font-weight: 500;
    }

    .modal-expert .modal-expert__icon {
      color: #93c5fd;
      width: 16px;
      text-align: center;
    }

    .modal-expert .modal-expert__input,
    .modal-expert .modal-expert__select,
    .modal-expert select,
    .modal-expert input[type="text"],
    .modal-expert input[type="email"],
    .modal-expert input[type="tel"],
    .modal-expert textarea,
    .modal-expert .acct-input {
      width: 100%;
      box-sizing: border-box;
      background: rgba(255, 255, 255, 0.05);
      color: #f8fafc;
      border: 1px solid rgba(255, 255, 255, 0.15);
      padding: 0.75rem 1rem;
      border-radius: 8px;
      font-size: 0.95rem;
      outline: none;
      transition: box-shadow .12s ease, border-color .12s ease;
    }

    .modal-expert .modal-expert__input:focus,
    .modal-expert select:focus,
    .modal-expert textarea:focus {
      border-color: var(--admin-accent-color);
      box-shadow: 0 0 0 4px rgba(58, 142, 255, 0.15);
    }

    .modal-expert .modal-expert__textarea {
      min-height: 96px;
      resize: vertical;
    }

    /* Price input - MODIFICADO para mejor organización */
    .modal-expert .srv-price-input,
    .modal-expert .price-input {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem;
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.15);
      background: rgba(255, 255, 255, 0.05);
    }

    .modal-expert .srv-currency,
    .modal-expert .currency-symbol {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 36px;
      height: 36px;
      color: #f8fafc;
      font-weight: 700;
      font-size: 0.95rem;
    }

    .modal-expert input.price-field {
      border: none;
      background: transparent;
      color: #f8fafc;
      padding: 0.5rem 0;
      flex: 1;
    }

    .modal-expert .srv-note,
    .modal-expert .hint,
    .modal-expert .modal-expert__hint {
      margin: 0.5rem 0 0 0;
      font-size: 0.82rem;
      color: #cbd5e1;
      line-height: 1.4;
    }

    /* Days selector - MODIFICADO para mejor organización */
    .modal-expert .srv-days-wrapper {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .modal-expert .srv-days {
      display: flex;
      gap: 0.4rem;
      flex-wrap: wrap;
    }

    .modal-expert .srv-day {
      background: transparent;
      border: 1px solid rgba(255, 255, 255, 0.15);
      color: #e2e8f0;
      width: 40px;
      height: 40px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: background .12s ease, color .12s ease, transform .06s ease;
    }

    .modal-expert .srv-day:hover {
      background: rgba(58, 142, 255, 0.1);
      color: #f8fafc;
      transform: translateY(-1px);
    }

    .modal-expert .srv-day.selected,
    .modal-expert .srv-day[aria-pressed="true"] {
      background: linear-gradient(180deg, var(--admin-accent-color), var(--admin-accent-color));
      color: #fff;
      border-color: transparent;
    }

    .modal-expert .srv-days-display {
      font-size: 0.9rem;
      color: #cbd5e1;
      padding: 0.5rem 0;
      min-height: 1.5rem;
    }

    /* Upload area - MODIFICADO para mejor organización */
    .modal-expert .modal-expert__upload-wrapper {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .modal-expert .modal-expert__file-input {
      display: none;
    }

    .modal-expert .modal-expert__upload-box {
      display: inline-flex;
      gap: 0.65rem;
      align-items: center;
      padding: 1rem;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px dashed rgba(255, 255, 255, 0.2);
      color: #cbd5e1;
      cursor: pointer;
      font-size: 0.95rem;
      transition: background .12s ease, color .12s ease;
    }

    .modal-expert .modal-expert__upload-box:hover {
      background: rgba(255, 255, 255, 0.08);
      color: #e2e8f0;
    }

    .modal-expert #profilePreview {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      min-width: 72px;
      min-height: 48px;
      max-height: 72px;
      overflow: hidden;
      border-radius: 8px;
    }

    .modal-expert #profilePreview img {
      display: block;
      width: 64px;
      height: 64px;
      object-fit: cover;
      border-radius: 6px;
    }

    .modal-expert #removeProfileBtn {
      display: none;
      background: rgba(0, 0, 0, 0.5);
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 0.25rem;
      cursor: pointer;
    }

    /* Account number toggle */
    .modal-expert .acct-wrap {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .modal-expert .acct-toggle {
      background: transparent;
      border: 1px solid rgba(255, 255, 255, 0.15);
      color: #cbd5e1;
      padding: 0.45rem 0.6rem;
      border-radius: 8px;
      cursor: pointer;
    }

    .modal-expert .acct-toggle:hover {
      background: rgba(255, 255, 255, 0.05);
      color: #e2e8f0;
    }

    /* Bank section - MODIFICADO para mejor organización */
    .modal-expert .bank-section {
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.05), transparent);
      padding: 1.25rem;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      margin-top: 1rem;
    }

    .modal-expert .bank-title {
      margin: 0 0 0.5rem 0;
      font-size: 1.1rem;
      color: #f1f5f9;
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    .modal-expert .bank-sub {
      margin: 0 0 1rem 0;
      color: #cbd5e1;
      font-size: 0.9rem;
    }

    .modal-expert .bank-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 1rem;
    }

    .modal-expert .bank-grid .full-width {
      grid-column: 1 / -1;
    }

    /* Info box small */
    .modal-expert .info-box.info-sm {
      margin-top: 1rem;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      padding: 1rem;
      border-radius: 8px;
      color: #cbd5e1;
    }

    .modal-expert .info-header {
      display: flex;
      gap: 0.5rem;
      align-items: center;
      margin-bottom: 0.5rem;
      color: #e2e8f0;
      font-weight: 600;
    }

    .modal-expert .info-list {
      margin: 0;
      padding: 0 0 0 1rem;
      display: block;
      color: #cbd5e1;
      font-size: 0.9rem;
      line-height: 1.6;
    }

    .modal-expert .info-list li {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.25rem;
    }

    /* Footer (keeps visible) */
    .modal-expert .modal-expert__footer {
      display: flex;
      gap: 0.75rem;
      align-items: center;
      justify-content: flex-end;
      padding: 1rem 1.25rem;
      border-top: 1px solid rgba(255, 255, 255, 0.08);
      background: linear-gradient(0deg, rgba(255, 255, 255, 0.03), transparent);
    }

    /* Buttons (lightweight overrides to match theme) */
    .modal-expert .btn-primary {
      background: linear-gradient(180deg, var(--admin-accent-color), var(--admin-accent-color));
      color: #fff;
      border: none;
      padding: 0.75rem 1.25rem;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: transform .1s ease, box-shadow .1s ease;
    }

    .modal-expert .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .modal-expert .btn-outline {
      background: transparent;
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: #cbd5e1;
      padding: 0.75rem 1.25rem;
      border-radius: 8px;
      cursor: pointer;
      transition: background .12s ease, color .12s ease;
    }

    .modal-expert .btn-outline:hover {
      color: #e2e8f0;
      background: rgba(255, 255, 255, 0.05);
    }

    /* Small utilities */
    .modal-expert .price-feedback {
      font-size: 0.85rem;
      color: var(--admin-accent-color);
      margin-top: 0.35rem;
    }

    .modal-expert .upload-error {
      color: #f87171;
      margin-top: 0.35rem;
      font-size: 0.9rem;
    }

    /* Input with icon */
    .modal-expert .input-with-icon {
      position: relative;
    }

    .modal-expert .input-with-icon::after {
      content: "\f078";
      /* Unicode for fa-chevron-down */
      font-family: "Font Awesome 5 Free";
      font-weight: 900;
      position: absolute;
      right: 1rem;
      top: 50%;
      transform: translateY(-50%);
      color: #cbd5e1;
      pointer-events: none;
      font-size: 0.875rem;
    }

    /* Responsive adjustments - MEJORADO */
    @media (max-width: 880px) {
      .modal-expert {
        padding: 20px;
      }

      .modal-expert .modal-expert__container {
        max-width: calc(100% - 40px);
        padding: 16px;
      }

      .modal-expert .modal-expert__grid {
        grid-template-columns: 1fr;
        gap: 1.25rem;
      }

      .modal-expert .modal-expert__grid .full-width {
        grid-column: auto;
      }

      .modal-expert .bank-grid {
        grid-template-columns: 1fr;
      }

      .modal-expert .bank-grid .full-width {
        grid-column: auto;
      }
    }

    @media (max-width: 420px) {
      .modal-expert {
        padding: 16px;
      }

      .modal-expert .modal-expert__container {
        border-radius: 8px;
        max-height: calc(100vh - 32px);
        padding: 12px;
      }

      .modal-expert .modal-expert__title {
        font-size: 1rem;
      }

      .modal-expert .srv-day {
        width: 36px;
        height: 36px;
        font-size: 0.85rem;
      }

      .modal-expert .modal-expert__footer {
        flex-direction: column;
        gap: 0.5rem;
        padding: 0.75rem;
      }

      .modal-expert .btn-primary,
      .modal-expert .btn-outline {
        width: 100%;
        text-align: center;
        padding: 0.875rem 1rem;
      }

      .modal-expert .modal-expert__grid {
        gap: 1rem;
      }

      .modal-expert .srv-days {
        justify-content: center;
      }
    }

    /* Fix visual para Choices dentro del modal - DISEÑO MEJORADO - VERSIÓN UNIVERSAL */
    .modal-expert .choices__inner {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.03)) !important;
      color: var(--admin-text-primary, #ffffff) !important;
      border: 1px solid rgba(94, 129, 255, 0.2) !important;
      min-height: 52px !important;
      box-shadow:
        0 4px 16px rgba(2, 6, 23, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.1) !important;
      border-radius: 12px !important;
      padding: 0.75rem 1rem !important;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
      position: relative !important;
    }

    /* Mejora para selección múltiple - estados más claros */
    .modal-expert .choices__inner:hover {
      border-color: rgba(94, 129, 255, 0.4) !important;
      box-shadow:
        0 8px 24px rgba(2, 6, 23, 0.4),
        0 0 0 1px rgba(94, 129, 255, 0.2),
        inset 0 1px 0 rgba(255, 255, 255, 0.15) !important;
      transform: translateY(-1px) !important;
    }

    .modal-expert .choices__inner:focus-within {
      border-color: var(--admin-accent-color, #5e81ff) !important;
      box-shadow:
        0 8px 32px rgba(94, 129, 255, 0.3),
        0 0 0 3px rgba(94, 129, 255, 0.15),
        inset 0 1px 0 rgba(255, 255, 255, 0.2) !important;
      transform: translateY(-2px) !important;
    }

    /* Mejor indicación visual para campos múltiples */
    .modal-expert .choices[data-type*="select-multiple"] .choices__inner::before {
      /* Oculto para un diseño más limpio */
      content: none !important;
      display: none !important;
    }

    /* Contenedor de elementos seleccionados - optimizado para múltiple */
    .modal-expert .choices__list--multiple {
      display: flex !important;
      flex-wrap: wrap !important;
      gap: 0.4rem !important;
      margin: 0 !important;
      padding: 0.5rem 0.6rem !important;
      max-height: 120px !important;
      overflow-y: auto !important;
      align-items: flex-start !important;
      align-content: flex-start !important;
    }

    /* Scrollbar para contenedor de seleccionados */
    .modal-expert .choices__list--multiple::-webkit-scrollbar {
      width: 4px !important;
    }

    .modal-expert .choices__list--multiple::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.05) !important;
      border-radius: 2px !important;
    }

    .modal-expert .choices__list--multiple::-webkit-scrollbar-thumb {
      background: rgba(94, 129, 255, 0.3) !important;
      border-radius: 2px !important;
    }

    /* Mejorar el contenedor principal cuando hay muchos elementos */
    .modal-expert .choices__inner {
      min-height: 46px !important;
      padding: 0.3rem 0.5rem !important;
    }

    /* Texto de placeholder cuando está vacío */
    .modal-expert .choices__placeholder {
      color: rgba(255, 255, 255, 0.5) !important;
      font-style: italic !important;
      margin: 0.5rem 0.6rem !important;
    }

    /* Campo de input para búsqueda */
    .modal-expert .choices__input {
      background: transparent !important;
      border: none !important;
      color: var(--admin-text-primary) !important;
      font-size: 0.9rem !important;
      padding: 0.4rem 0.6rem !important;
      margin: 0 !important;
      min-width: 100px !important;
      flex-grow: 1 !important;
    }

    .modal-expert .choices__input::placeholder {
      color: rgba(255, 255, 255, 0.4) !important;
    }

    /* Mejorar dropdown de opciones */
    .modal-expert .choices__list--dropdown {
      background: var(--admin-card-bg) !important;
      border: 1px solid var(--admin-border-color) !important;
      border-radius: 8px !important;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4) !important;
      max-height: 200px !important;
      overflow-y: auto !important;
      z-index: 1000 !important;
      margin-top: 2px !important;
    }

    .modal-expert .choices__list--dropdown .choices__item {
      padding: 0.7rem 1rem !important;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05) !important;
      transition: all 0.2s ease !important;
      font-size: 0.9rem !important;
      color: var(--admin-text-primary) !important;
    }

    .modal-expert .choices__list--dropdown .choices__item:last-child {
      border-bottom: none !important;
    }

    .modal-expert .choices__list--dropdown .choices__item:hover,
    .modal-expert .choices__list--dropdown .choices__item.is-highlighted {
      background: var(--admin-accent-color) !important;
      color: #ffffff !important;
      transform: translateX(2px) !important;
    }

    .modal-expert .choices__list--dropdown .choices__item[aria-selected="true"] {
      background: rgba(94, 129, 255, 0.2) !important;
      color: var(--admin-accent-color) !important;
      position: relative !important;
    }

    .modal-expert .choices__list--dropdown .choices__item[aria-selected="true"]::after {
      content: '✓' !important;
      position: absolute !important;
      right: 1rem !important;
      font-weight: bold !important;
    }

    /* Animación para el contenedor cuando se abre */
    .modal-expert .choices[data-type*="select-multiple"].is-open .choices__inner {
      border-color: var(--admin-accent-color) !important;
      box-shadow: 0 0 0 2px rgba(94, 129, 255, 0.2) !important;
    }

    /* Estilos para scrollbar personalizado en el dropdown */
    .modal-expert .choices__list--dropdown::-webkit-scrollbar {
      width: 6px !important;
    }

    .modal-expert .choices__list--dropdown::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.1) !important;
      border-radius: 3px !important;
    }

    .modal-expert .choices__list--dropdown::-webkit-scrollbar-thumb {
      background: var(--admin-accent-color) !important;
      border-radius: 3px !important;
    }

    .modal-expert .choices__list--dropdown::-webkit-scrollbar-thumb:hover {
      background: rgba(94, 129, 255, 0.8) !important;
    }

    /* Mensaje cuando no hay opciones */
    .modal-expert .choices__placeholder {
      opacity: 0.6 !important;
      font-style: italic !important;
    }

    /* Estilos para cuando el dropdown está vacío */
    .modal-expert .choices__list--dropdown .choices__item--choice.has-no-choices {
      color: rgba(255, 255, 255, 0.4) !important;
      font-style: italic !important;
      pointer-events: none !important;
    }

    /* Mejora la transición al abrir/cerrar el dropdown */
    .modal-expert .choices__list--dropdown {
      opacity: 0 !important;
      transform: translateY(-10px) !important;
      transition: all 0.2s ease !important;
    }

    .modal-expert .choices.is-open .choices__list--dropdown {
      opacity: 1 !important;
      transform: translateY(0) !important;
    }

    /* Estilo para el contador de elementos seleccionados */
    .modal-expert .field-label-wrapper {
      position: relative !important;
    }

    .modal-expert .selection-count {
      position: absolute !important;
      right: 0 !important;
      top: 50% !important;
      transform: translateY(-50%) !important;
      background: var(--admin-accent-color) !important;
      color: white !important;
      padding: 0.2rem 0.5rem !important;
      border-radius: 12px !important;
      font-size: 0.7rem !important;
      font-weight: bold !important;
      opacity: 0 !important;
      transition: opacity 0.3s ease !important;
    }

    .modal-expert .choices.has-items+.selection-count {
      opacity: 1 !important;
    }

    /* Tags/Chips de elementos seleccionados - DISEÑO MEJORADO PARA MÚLTIPLES */
    .modal-expert .choices__list--multiple .choices__item {
      background: linear-gradient(135deg, var(--admin-accent-color, #5e81ff), #4f46e5) !important;
      color: #ffffff !important;
      border: none !important;
      border-radius: 20px !important;
      padding: 0.4rem 0.75rem 0.4rem 1rem !important;
      font-size: 0.85rem !important;
      font-weight: 500 !important;
      display: inline-flex !important;
      align-items: center !important;
      gap: 0.5rem !important;
      transition: all 0.2s ease !important;
      box-shadow:
        0 2px 8px rgba(94, 129, 255, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.2) !important;
      position: relative !important;
      overflow: hidden !important;
      max-width: 200px !important;
      white-space: nowrap !important;
      text-overflow: ellipsis !important;
    }

    /* Contador de elementos seleccionados */
    .modal-expert .choices[data-type*="select-multiple"] .choices__inner::after {
      content: attr(data-choice-count) " seleccionados" !important;
      position: absolute !important;
      bottom: -20px !important;
      left: 0 !important;
      font-size: 12px !important;
      color: rgba(255, 255, 255, 0.6) !important;
      font-style: italic !important;
    }

    /* Placeholder mejorado para múltiples */
    .modal-expert .choices__placeholder {
      color: rgba(255, 255, 255, 0.6) !important;
      font-style: italic !important;
      opacity: 1 !important;
    }

    .modal-expert .choices[data-type*="select-multiple"] .choices__placeholder::after {
      content: " (Ctrl/Cmd+Click para múltiple)" !important;
      font-size: 11px !important;
      opacity: 0.7 !important;
    }

    /* Dropdown mejorado para selección múltiple */
    .modal-expert .choices__list--dropdown .choices__item {
      background: transparent !important;
      color: var(--admin-text-primary, #ffffff) !important;
      padding: 1rem 1.25rem !important;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05) !important;
      transition: all 0.2s ease !important;
      position: relative !important;
      cursor: pointer !important;
    }

    /* Indicador de selección en dropdown */
    .modal-expert .choices__list--dropdown .choices__item[aria-selected="true"] {
      background: linear-gradient(90deg, rgba(94, 129, 255, 0.2), rgba(94, 129, 255, 0.1)) !important;
      color: #fff !important;
    }

    .modal-expert .choices__list--dropdown .choices__item[aria-selected="true"]::before {
      content: "✓" !important;
      position: absolute !important;
      right: 1rem !important;
      color: var(--admin-accent-color, #5e81ff) !important;
      font-weight: bold !important;
    }

    /* Hover en opciones */
    .modal-expert .choices__list--dropdown .choices__item.is-highlighted,
    .modal-expert .choices__list--dropdown .choices__item.choice--selectable.is-highlighted {
      background: linear-gradient(90deg, rgba(94, 129, 255, 0.15), rgba(94, 129, 255, 0.05)) !important;
      color: #fff !important;
      transform: translateX(4px) !important;
    }

    /* Animaciones para mejor feedback */
    .modal-expert .choices__list--multiple .choices__item {
      animation: tagSlideIn 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
    }

    @keyframes tagSlideIn {
      from {
        opacity: 0;
        transform: translateY(-10px) scale(0.8);
      }

      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    /* Estado cuando hay muchos elementos seleccionados */
    .modal-expert .choices__list--multiple.has-many-items {
      max-height: 80px !important;
      overflow-y: auto !important;
    }

    /* Indicador visual de campo requerido */
    .modal-expert select[required]+.choices::before {
      content: "*" !important;
      position: absolute !important;
      top: -5px !important;
      right: -5px !important;
      color: #ef4444 !important;
      font-size: 16px !important;
      font-weight: bold !important;
      z-index: 10 !important;
    }

    /* Tags/Chips de elementos seleccionados - DISEÑO MEJORADO */
    .modal-expert .choices__list--multiple .choices__item {
      background: linear-gradient(135deg, var(--admin-accent-color, #5e81ff), #4f46e5) !important;
      color: #ffffff !important;
      border: none !important;
      border-radius: 16px !important;
      padding: 0.4rem 0.75rem 0.4rem 1rem !important;
      font-size: 0.8rem !important;
      font-weight: 500 !important;
      display: inline-flex !important;
      align-items: center !important;
      gap: 0.4rem !important;
      margin: 0.2rem 0.3rem 0.2rem 0 !important;
      transition: all 0.2s ease !important;
      box-shadow:
        0 2px 6px rgba(94, 129, 255, 0.25),
        inset 0 1px 0 rgba(255, 255, 255, 0.15) !important;
      position: relative !important;
      overflow: hidden !important;
      max-width: 200px !important;
      text-overflow: ellipsis !important;
      white-space: nowrap !important;
    }

    .modal-expert .choices__list--multiple .choices__item::before {
      content: '' !important;
      position: absolute !important;
      top: 0 !important;
      left: 0 !important;
      right: 0 !important;
      bottom: 0 !important;
      background: linear-gradient(45deg, transparent 30%, rgba(255, 255, 255, 0.08) 50%, transparent 70%) !important;
      opacity: 0 !important;
      transition: opacity 0.3s ease !important;
    }

    .modal-expert .choices__list--multiple .choices__item:hover::before {
      opacity: 1 !important;
    }

    .modal-expert .choices__list--multiple .choices__item:hover {
      transform: translateY(-1px) !important;
      box-shadow:
        0 4px 12px rgba(94, 129, 255, 0.35),
        inset 0 1px 0 rgba(255, 255, 255, 0.2) !important;
    }

    /* Botón de eliminar en los chips */
    .modal-expert .choices__list--multiple .choices__item .choices__button {
      background: rgba(255, 255, 255, 0.2) !important;
      border: none !important;
      border-radius: 50% !important;
      color: #ffffff !important;
      width: 16px !important;
      height: 16px !important;
      padding: 0 !important;
      margin-left: 0.3rem !important;
      font-size: 10px !important;
      line-height: 1 !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      transition: all 0.2s ease !important;
      cursor: pointer !important;
    }

    .modal-expert .choices__list--multiple .choices__item .choices__button:hover {
      background: rgba(255, 77, 87, 0.9) !important;
      transform: scale(1.1) !important;
    }

    .modal-expert .choices__list--multiple .choices__item .choices__button:before {
      content: '×' !important;
      font-size: 12px !important;
      font-weight: bold !important;
      transform: translateX(-100%) !important;
      transition: transform 0.6s ease !important;
    }

    .modal-expert .choices__list--multiple .choices__item:hover::before {
      transform: translateX(100%) !important;
    }

    .modal-expert .choices__list--multiple .choices__item:hover {
      transform: translateY(-2px) scale(1.05) !important;
      box-shadow:
        0 6px 20px rgba(94, 129, 255, 0.4),
        inset 0 1px 0 rgba(255, 255, 255, 0.3) !important;
    }

    /* Input de búsqueda dentro del campo */
    .modal-expert .choices__input,
    .modal-expert .choices__input--cloned {
      color: var(--admin-text-primary, #ffffff) !important;
      background: transparent !important;
      caret-color: var(--admin-accent-color, #5e81ff) !important;
      border: none !important;
      padding: 0.5rem 0 !important;
      font-size: 0.95rem !important;
      min-width: 200px !important;
    }

    .modal-expert .choices__input::placeholder {
      color: rgba(255, 255, 255, 0.5) !important;
      font-style: italic !important;
    }

    /* Dropdown mejorado */
    .modal-expert .choices__list--dropdown {
      background: rgba(11, 18, 32, 0.95) !important;
      backdrop-filter: blur(20px) !important;
      color: var(--admin-text-primary, #ffffff) !important;
      border: 1px solid rgba(94, 129, 255, 0.3) !important;
      z-index: 2000 !important;
      box-shadow:
        0 16px 48px rgba(2, 6, 23, 0.7),
        0 0 0 1px rgba(94, 129, 255, 0.2),
        inset 0 1px 0 rgba(255, 255, 255, 0.1) !important;
      max-height: 240px !important;
      overflow: auto !important;
      border-radius: 16px !important;
      margin-top: 0.5rem !important;
      animation: dropdownSlideIn 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
    }

    /* === MEJORAS ESPECÍFICAS PARA VISIBILIDAD DEL DROPDOWN === */
    .modal-expert .choices__list--dropdown {
      background: var(--admin-bg-secondary, #1a1d29) !important;
      border: 1px solid rgba(94, 129, 255, 0.3) !important;
      border-radius: 12px !important;
      box-shadow:
        0 10px 40px rgba(0, 0, 0, 0.5),
        0 2px 16px rgba(94, 129, 255, 0.2) !important;
      backdrop-filter: blur(16px) !important;
      z-index: 9999 !important;
      max-height: 300px !important;
      overflow-y: auto !important;
    }

    /* Mejorar contraste de opciones */
    .modal-expert .choices__list--dropdown .choices__item {
      background: transparent !important;
      color: var(--admin-text-primary, #ffffff) !important;
      padding: 0.875rem 1.25rem !important;
      border-bottom: 1px solid rgba(255, 255, 255, 0.08) !important;
      font-size: 0.925rem !important;
      font-weight: 500 !important;
      transition: all 0.15s ease !important;
      cursor: pointer !important;
    }

    /* Hover más visible */
    .modal-expert .choices__list--dropdown .choices__item:hover,
    .modal-expert .choices__list--dropdown .choices__item.is-highlighted {
      background: linear-gradient(90deg, rgba(94, 129, 255, 0.25), rgba(94, 129, 255, 0.15)) !important;
      color: #ffffff !important;
      transform: translateX(6px) !important;
      border-left: 3px solid var(--admin-accent-color, #5e81ff) !important;
    }

    /* Opciones seleccionadas */
    .modal-expert .choices__list--dropdown .choices__item[aria-selected="true"] {
      background: linear-gradient(90deg, rgba(34, 197, 94, 0.2), rgba(34, 197, 94, 0.1)) !important;
      color: #ffffff !important;
      border-left: 3px solid #22c55e !important;
    }

    .modal-expert .choices__list--dropdown .choices__item[aria-selected="true"]::after {
      content: "✓" !important;
      position: absolute !important;
      right: 1.25rem !important;
      color: #22c55e !important;
      font-weight: bold !important;
      font-size: 1rem !important;
    }

    /* === FIN MEJORAS DROPDOWN === */

    @keyframes dropdownSlideIn {
      from {
        opacity: 0;
        transform: translateY(-10px) scale(0.95);
      }

      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .modal-expert .choices__list--dropdown .choices__item {
      background: transparent !important;
      color: var(--admin-text-primary, #ffffff) !important;
      padding: 1rem 1.25rem !important;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05) !important;
      transition: all 0.2s ease !important;
      position: relative !important;
    }

    .modal-expert .choices__list--dropdown .choices__item:last-child {
      border-bottom: none !important;
    }

    .modal-expert .choices__list--dropdown .choices__item::before {
      content: '' !important;
      position: absolute !important;
      left: 0 !important;
      top: 0 !important;
      bottom: 0 !important;
      width: 3px !important;
      background: var(--admin-accent-color, #5e81ff) !important;
      transform: scaleY(0) !important;
      transition: transform 0.2s ease !important;
    }

    .modal-expert .choices__list--dropdown .choices__item.is-highlighted,
    .modal-expert .choices__list--dropdown .choices__item.choice--selectable.is-highlighted {
      background: linear-gradient(90deg, rgba(94, 129, 255, 0.15), rgba(94, 129, 255, 0.05)) !important;
      color: #fff !important;
      transform: translateX(4px) !important;
    }

    .modal-expert .choices__list--dropdown .choices__item.is-highlighted::before {
      transform: scaleY(1) !important;
    }

    /* Botón de eliminar elemento - DISEÑO MEJORADO */
    .modal-expert .choices__button {
      color: rgba(255, 255, 255, 0.8) !important;
      background: rgba(255, 255, 255, 0.15) !important;
      border: 1px solid rgba(255, 255, 255, 0.2) !important;
      border-radius: 50% !important;
      width: 20px !important;
      height: 20px !important;
      display: inline-flex !important;
      align-items: center !important;
      justify-content: center !important;
      padding: 0 !important;
      margin-left: 0.25rem !important;
      transition: all 0.2s ease !important;
      position: relative !important;
      overflow: hidden !important;
    }

    .modal-expert .choices__button::before {
      content: '' !important;
      position: absolute !important;
      top: 0 !important;
      left: 0 !important;
      right: 0 !important;
      bottom: 0 !important;
      background: linear-gradient(45deg, rgba(255, 255, 255, 0.2), transparent) !important;
      transform: translateX(-100%) !important;
      transition: transform 0.3s ease !important;
    }

    .modal-expert .choices__button:hover {
      background: rgba(239, 68, 68, 0.8) !important;
      border-color: rgba(239, 68, 68, 1) !important;
      color: #ffffff !important;
      transform: scale(1.1) !important;
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4) !important;
    }

    .modal-expert .choices__button:hover::before {
      transform: translateX(100%) !important;
    }

    .modal-expert .choices__button svg {
      width: 12px !important;
      height: 12px !important;
      display: block !important;
      stroke: currentColor !important;
      stroke-width: 2 !important;
      fill: none !important;
    }

    /* Scrollbar personalizado para dropdown */
    .modal-expert .choices__list--dropdown::-webkit-scrollbar {
      width: 6px !important;
    }

    .modal-expert .choices__list--dropdown::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.05) !important;
      border-radius: 3px !important;
    }

    .modal-expert .choices__list--dropdown::-webkit-scrollbar-thumb {
      background: rgba(94, 129, 255, 0.4) !important;
      border-radius: 3px !important;
      transition: background 0.2s ease !important;
    }

    .modal-expert .choices__list--dropdown::-webkit-scrollbar-thumb:hover {
      background: rgba(94, 129, 255, 0.6) !important;
    }

    /* Estados especiales */
    .modal-expert .choices[data-type*="select-multiple"].is-open .choices__inner {
      border-color: var(--admin-accent-color, #5e81ff) !important;
      box-shadow:
        0 8px 32px rgba(94, 129, 255, 0.3),
        0 0 0 3px rgba(94, 129, 255, 0.15),
        inset 0 1px 0 rgba(255, 255, 255, 0.2) !important;
    }

    /* Campo vacío placeholder mejorado */
    .modal-expert .choices__placeholder {
      color: rgba(255, 255, 255, 0.6) !important;
      font-style: italic !important;
      opacity: 1 !important;
    }

    /* Animación de entrada para nuevos elementos */
    .modal-expert .choices__list--multiple .choices__item {
      animation: tagSlideIn 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
    }

    @keyframes tagSlideIn {
      from {
        opacity: 0;
        transform: translateY(-10px) scale(0.8);
      }

      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    /* Inline field error messages */
    .modal-expert .field-error {
      color: #f87171;
      font-size: 0.85rem;
      margin-top: 0.5rem;
      display: block;
    }

    /* Nuevos estilos para mejorar la organización visual */
    .modal-expert .form-section {
      margin-bottom: 1.5rem;
      padding-bottom: 1.5rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.08);
    }

    .modal-expert .form-section:last-child {
      border-bottom: none;
      margin-bottom: 0;
      padding-bottom: 0;
    }

    .modal-expert .form-section-title {
      font-size: 1rem;
      font-weight: 600;
      color: #e2e8f0;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    /* Simplified field containers */
    .modal-expert .form-field {
      display: flex;
      flex-direction: column;
      margin-bottom: 1rem;
    }

    .modal-expert .form-field:last-child {
      margin-bottom: 0;
    }

    .modal-expert .form-field label {
      margin-bottom: 0.5rem;
      font-weight: 500;
      color: #e2e8f0;
    }

    /* Estilos para tooltips e información adicional */
    .modal-expert .icon-tooltip {
      cursor: help;
      position: relative;
    }

    .modal-expert .icon-tooltip:hover::after {
      content: attr(title);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 0.5rem;
      border-radius: 4px;
      font-size: 0.8rem;
      white-space: nowrap;
      z-index: 1000;
    }

    /* CSS ESPECÍFICO PARA HABILIDADES - Asegurar que se vean igual que las categorías */
    .modal-expert__select-habilidades {
      position: relative !important;
    }

    /* Forzar el estilo de Choices.js en habilidades */
    .modal-expert .modal-expert__select-habilidades:not(.choices-initialized) {
      /* Mientras no esté inicializado con Choices.js, mantenerlo usable */
      opacity: 1 !important;
      pointer-events: auto !important;
    }

    /* Al estar inicializado con Choices, ocultar el select nativo */
    .modal-expert select.choices-initialized,
    .modal-expert .modal-expert__select-habilidades.choices-initialized,
    .modal-expert .modal-expert__select-categorias.choices-initialized {
      display: none !important;
      opacity: 0 !important;
      pointer-events: none !important;
    }

    /* Asegurar que el contenedor Choices tome todo el ancho */
    .modal-expert .choices {
      width: 100% !important;
      margin-top: 0 !important;
    }

    /* Aplicar base a Choices__inner (habilidades y categorías) */
    .modal-expert [data-select="habilidades"] .choices__inner,
    .modal-expert [data-select="categorias"] .choices__inner,
    .modal-expert #habilidades+.choices .choices__inner,
    .modal-expert #categorias+.choices .choices__inner,
    .modal-expert #skills+.choices .choices__inner,
    .modal-expert #edit_categorias+.choices .choices__inner,
    .modal-expert #ver_habilidades+.choices .choices__inner,
    .modal-expert #ver_categorias+.choices .choices__inner {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.03)) !important;
      color: var(--admin-text-primary) !important;
      border: 1px solid rgba(94, 129, 255, 0.2) !important;
      min-height: 52px !important;
      box-shadow: 0 4px 16px rgba(2, 6, 23, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.1) !important;
      border-radius: 12px !important;
      padding: 0.75rem 1rem !important;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
      position: relative !important;
    }

    /* Overrides para categorías: dejar que el wrapper sea el marco */
    .modal-expert #categorias+.choices .choices__inner,
    .modal-expert #edit_categorias+.choices .choices__inner,
    .modal-expert #ver_categorias+.choices .choices__inner {
      background: transparent !important;
      border-color: transparent !important;
      box-shadow: none !important;
      padding: 0 !important;
    }

    /* Si existe wrapper .choices-container (categorías), asegura un solo recuadro */
    .modal-expert .choices-container .choices .choices__inner {
      background: transparent !important;
      border: 0 !important;
      box-shadow: none !important;
      padding: 0 !important;
    }

    /* CSS adicional para mejorar la apariencia mientras se carga Choices.js */
    .modal-expert__select-habilidades option {
      background: var(--admin-card-bg) !important;
      color: var(--admin-text-primary) !important;
      padding: 8px 12px !important;
    }

    .modal-expert__select-habilidades:focus {
      outline: 2px solid var(--admin-accent-color) !important;
      outline-offset: 2px !important;
    }

    /* Estilo temporal mientras Choices.js se inicializa */
    .modal-expert__select-habilidades:not(.choices-initialized) {
      background: var(--admin-card-bg) !important;
      border: 1px solid var(--admin-border-color) !important;
      color: var(--admin-text-primary) !important;
      border-radius: 8px !important;
      padding: 8px 12px !important;
      min-height: 44px !important;
      font-size: 14px !important;
    }

    /* Tooltip fuera del bloque anterior */
    .modal-expert .icon-tooltip:hover::after {
      content: attr(title);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 0.5rem;
      border-radius: 4px;
      font-size: 0.8rem;
      white-space: nowrap;
      z-index: 1000;
    }
  </style>

  <!-- Modal para agregar experto -->
  <div id="expertModal" class="modal-expert" style="display:none;">
    <div class="modal-expert__container">
      <div class="modal-expert__header">
        <h2 class="modal-expert__title">Agregar experto</h2>
        <button class="btn-close" aria-label="Cerrar"><i class="fas fa-times"></i></button>
      </div>

      <div class="modal-expert__body">
        <form id="expertForm">
          <!-- Layout helper: responsive two-column grid for most rows -->
          <div class="modal-expert__grid">

            <!-- Información básica -->
            <div>
              <label class="modal-expert__label" for="add_name">
                <i class="fas fa-user modal-expert__icon" aria-hidden="true"></i>
                Nombre completo
              </label>
              <input type="text" id="add_name" placeholder="Nombre y apellidos registrados"
                class="modal-expert__input" />
            </div>

            <div>
              <label class="modal-expert__label" for="add_email">
                <i class="fas fa-envelope modal-expert__icon" aria-hidden="true"></i>
                Email registrado
              </label>
              <input type="email" id="add_email" placeholder="Email de la cuenta" class="modal-expert__input" />
            </div>

            <!-- Precio por hora (columna) -->
            <div>
              <label for="precio" class="modal-expert__label">
                <i class="fas fa-money-bill-wave modal-expert__icon" aria-hidden="true" title="Precio"></i>
                Precio por hora (COP)
                <span class="price-tooltip icon-tooltip" title="Ejemplo recomendado: $30.000 - $200.000 COP"
                  style="margin-left:.5rem;">
                  <i class="fas fa-info-circle"></i>
                </span>
              </label>

              <div class="srv-price-input price-input">
                <span class="srv-currency currency-symbol">$</span>
                <input type="number" id="precio" name="precio" min="10000" step="100" required placeholder="Ej: 50000"
                  class="srv-input price-field" />
              </div>
              <p class="srv-note price-note">
                Tarifa por hora de asesoría (Recomendado: $30.000 - $200.000 COP)
              </p>
              <div id="precio-feedback" class="srv-feedback price-feedback" aria-live="polite"></div>
            </div>

            <!-- Días disponibles (columna) -->
            <div>
              <label for="diasDisponibles" class="modal-expert__label">
                <i class="fas fa-calendar-alt modal-expert__icon" aria-hidden="true"></i>
                Días disponibles
              </label>

              <div class="srv-days-wrapper">
                <div class="srv-days">
                  <button type="button" class="srv-day" data-day="Lunes" aria-pressed="false">L</button>
                  <button type="button" class="srv-day" data-day="Martes" aria-pressed="false">M</button>
                  <button type="button" class="srv-day" data-day="Miércoles" aria-pressed="false">X</button>
                  <button type="button" class="srv-day" data-day="Jueves" aria-pressed="false">J</button>
                  <button type="button" class="srv-day" data-day="Viernes" aria-pressed="false">V</button>
                  <button type="button" class="srv-day" data-day="Sábado" aria-pressed="false">S</button>
                  <button type="button" class="srv-day" data-day="Domingo" aria-pressed="false">D</button>
                </div>

                <div class="srv-days-display">
                  Ningún día seleccionado
                </div>
              </div>

              <input type="hidden" id="diasDisponibles" name="diasDisponibles" />
            </div>

            <!-- Especialidad principal -->
            <div>
              <label class="modal-expert__label" for="specialty">
                <i class="fas fa-briefcase modal-expert__icon" aria-hidden="true"></i>
                Especialidad principal
              </label>
              <div class="input-with-icon">
                <select id="specialty" class="modal-expert__input modal-expert__select"
                  aria-label="Especialidad principal">
                  <option value="">Seleccionar especialidad</option>
                  <option value="web">Desarrollo Web</option>
                  <option value="mobile">Desarrollo Móvil</option>
                  <option value="data">Ciencia de Datos</option>
                  <option value="uxui">UX/UI</option>
                  <option value="devops">DevOps</option>
                  <option value="blockchain">Blockchain</option>
                  <option value="cloud">Cloud Computing</option>
                </select>
              </div>
              <small class="modal-expert__hint">Selecciona la especialidad principal que describe mejor al
                experto</small>
            </div>

            <!-- Estado -->
            <div>
              <label class="modal-expert__label" for="status">
                <i class="fas fa-toggle-on modal-expert__icon" aria-hidden="true"></i>
                Estado
              </label>
              <div class="input-with-icon">
                <select id="status" class="modal-expert__input modal-expert__select" aria-label="Estado del experto">
                  <option value="active">Activo</option>
                  <option value="pending">Pendiente</option>
                  <option value="inactive">Inactivo</option>
                </select>
              </div>
              <small class="modal-expert__hint">Define si el experto puede recibir solicitudes</small>
            </div>

            <!-- Categorías (full width) -->
            <div class="full-width">
              <label class="modal-expert__label" for="categorias">
                <i class="fas fa-tags modal-expert__icon" aria-hidden="true"></i>
                Categorías
              </label>
              <select id="categorias" class="modal-expert__input modal-expert__select-categorias" multiple size="4"
                aria-label="Categorías">
                <!-- DEBUG: Verificación de categorías -->
                <!-- Tipo categorias: <%= typeof categorias %> -->
                <!-- Es array: <%= Array.isArray(categorias) %> -->
                <!-- Cantidad: <%= (categorias && categorias.length) || 'N/A' %> -->
                <% if (typeof categorias !=='undefined' && Array.isArray(categorias) && categorias.length> 0) { %>
                  <!-- Categorías encontradas: <%= categorias.length %> -->
                  <% categorias.forEach(function(c, index) { %>
                    <% const catId=(c && c._id) ? String(c._id) : (c && (c.nombre || c.name || c.label) ? (c.nombre ||
                      c.name || c.label) : '' ); %>
                      <% const catLabel=(c && (c.nombre || c.name || c.label)) ? (c.nombre || c.name || c.label) :
                        catId; %>
                        <!-- Debug cat <%= index %>: id="<%= catId %>", label="<%= catLabel %>" -->
                        <% if (catId) { %>
                          <option value="<%= catId %>">
                            <%= catLabel %>
                          </option>
                          <% } %>
                            <% }); %>
                              <% } else { %>
                                <!-- Debug: No hay categorías. Tipo: <%= typeof categorias %>, Array: <%= Array.isArray(categorias) %>, Length: <%= (categorias && categorias.length) || 'N/A' %> -->
                                <option disabled>No hay categorías disponibles</option>
                                <% } %>
              </select>
              <small class="modal-expert__hint">Selecciona una o varias categorías (Ctrl/Cmd+click)</small>
            </div>

            <!-- Habilidades (full width) -->
            <div class="full-width">
              <label class="modal-expert__label" for="habilidades">
                <i class="fas fa-tools modal-expert__icon" aria-hidden="true"></i>
                Habilidades
              </label>
              <select id="habilidades" class="modal-expert__input modal-expert__select-habilidades" multiple size="6">
                <% if (typeof habilidades !=='undefined' && Array.isArray(habilidades) && habilidades.length> 0) { %>
                  <% habilidades.forEach(function(h, idx) { %>
                    <% const val=(h && (h.nombre || h.name || h.label)) ? (h.nombre || h.name || h.label) : (h && h._id
                      ? String(h._id) : '' ); %>
                      <% if (val) { %>
                        <option value="<%= val %>">
                          <%= val %>
                        </option>
                        <% } %>
                          <% }); %>
                            <% } else { %>
                              <!-- Debug habilidades: tipo=<%= typeof habilidades %>, esArray=<%= Array.isArray(habilidades) %>, cantidad=<%= (habilidades && habilidades.length) || 'N/A' %> -->
                              <option disabled>No hay habilidades disponibles</option>
                              <% } %>
              </select>
              <small class="modal-expert__hint">Selecciona o escribe para añadir nuevas habilidades</small>
            </div>

            <!-- Biografía -->
            <div class="full-width">
              <label class="modal-expert__label" for="bio">
                <i class="fas fa-file-alt modal-expert__icon" aria-hidden="true"></i>
                Biografía profesional
              </label>
              <textarea id="bio" rows="4" placeholder="Descripción breve de experiencia y especialización"
                class="modal-expert__input modal-expert__textarea"></textarea>
            </div>

            <!-- Imagen de perfil -->
            <div class="full-width">
              <label class="modal-expert__label" for="profileImage">
                <i class="fas fa-image modal-expert__icon" aria-hidden="true"></i>
                Imagen de perfil
              </label>

              <div class="modal-expert__upload-wrapper">
                <!-- hidden but accessible -->
                <input type="file" id="profileImage" class="modal-expert__file-input"
                  aria-label="Seleccionar imagen de perfil" accept="image/*" />

                <!-- visual upload box (acts as label) -->
                <label for="profileImage" class="modal-expert__upload-box" role="button" aria-haspopup="dialog">
                  <i class="fas fa-upload" aria-hidden="true"></i>
                  <span id="uploadLabel">Seleccionar imagen (png, jpg) · Máx 2MB</span>
                </label>

                <!-- preview thumbnail -->
                <div id="profilePreview" aria-hidden="true" role="img" aria-label="Vista previa de imagen">
                  <button id="removeProfileBtn" type="button" title="Eliminar imagen" aria-label="Eliminar imagen"
                    style="display:none;">
                    <i class="fas fa-times"></i>
                  </button>
                  <img src="" alt="Preview" />
                </div>

                <div class="upload-meta" id="uploadMeta" aria-live="polite" style="display:none;"></div>
                <div class="upload-error" id="profileImageError" role="alert" style="display:none;"></div>
              </div>
            </div>

            <!-- Espacio reservado para mantener la columna alineada -->
            <div aria-hidden="true"></div>

            <!-- Sección bancaria (tarjeta de ancho completo) -->
            <div class="full-width">
              <div class="bank-section">
                <h3 class="bank-title">
                  <i class="fas fa-university"></i> Datos Bancarios para Pagos
                </h3>
                <p class="bank-sub">Información necesaria para recibir pagos por tus asesorías</p>

                <div class="bank-grid">
                  <div>
                    <label for="banco">Banco *</label>
                    <div id="banco-wrapper">
                      <select id="banco" name="banco" required class="modal-expert__input">
                        <option value="">Selecciona tu banco</option>
                        <option value="Banco de Bogotá">Banco de Bogotá</option>
                        <option value="Bancolombia">Bancolombia</option>
                        <option value="Banco Popular">Banco Popular</option>
                        <option value="Banco AV Villas">Banco AV Villas</option>
                        <option value="Banco Caja Social">Banco Caja Social</option>
                        <option value="Banco de Occidente">Banco de Occidente</option>
                        <option value="Banco GNB Sudameris">Banco GNB Sudameris</option>
                        <option value="Banco Itaú">Banco Itaú</option>
                        <option value="Banco Pichincha">Banco Pichincha</option>
                        <option value="Banco Santander">Banco Santander</option>
                        <option value="Banco Scotiabank Colpatria">Banco Scotiabank Colpatria</option>
                        <option value="Davivienda">Davivienda</option>
                        <option value="Banco Agrario">Banco Agrario</option>
                        <option value="Banco Falabella">Banco Falabella</option>
                        <option value="Banco Finandina">Banco Finandina</option>
                        <option value="Banco W">Banco W</option>
                        <option value="Banco Serfinanza">Banco Serfinanza</option>
                        <option value="Banco Cooperativo Coopcentral">Banco Cooperativo Coopcentral</option>
                        <option value="Banco BBVA">Banco BBVA</option>
                        <option value="Nequi">Nequi</option>
                        <option value="Daviplata">Daviplata</option>
                        <option value="Movii">Movii</option>
                        <option value="Banco de Vivienda">Banco de Vivienda</option>
                        <option value="Banco ProCredit">Banco ProCredit</option>
                        <option value="Banco Multibank">Banco Multibank</option>
                        <option value="Banco Coopcentral">Banco Coopcentral</option>
                        <option value="Banco Credifinanciera">Banco Credifinanciera</option>
                        <option value="Banco Mundo Mujer">Banco Mundo Mujer</option>
                        <option value="Banco Ripley">Banco Ripley</option>
                        <option value="Banco CrediScotia">Banco CrediScotia</option>
                      </select>
                    </div>
                  </div>

                  <div>
                    <label for="tipoCuenta">Tipo de cuenta *</label>
                    <div id="tipoCuenta-wrapper">
                      <select id="tipoCuenta" name="tipoCuenta" required class="modal-expert__input">
                        <option value="">Selecciona el tipo</option>
                        <option value="Cuenta de Ahorros">Cuenta de Ahorros</option>
                        <option value="Cuenta Corriente">Cuenta Corriente</option>
                        <option value="Cuenta de Nómina">Cuenta de Nómina</option>
                        <option value="Cuenta Digital">Cuenta Digital</option>
                      </select>
                    </div>
                  </div>

                  <div>
                    <label for="numeroCuenta">Número de cuenta *</label>
                    <div class="acct-wrap">
                      <input type="password" id="numeroCuenta" name="numeroCuenta" required
                        placeholder="Número de cuenta" pattern="[0-9\-]*" title="Solo números y guiones"
                        class="acct-input">
                      <button type="button" id="toggleAccountNumber" class="acct-toggle"
                        aria-label="Mostrar número de cuenta">
                        <i class="fas fa-eye"></i>
                      </button>
                    </div>
                    <p class="hint">Número completo de tu cuenta</p>
                  </div>

                  <div>
                    <label for="titular">Titular de la cuenta *</label>
                    <input type="text" id="titular" name="titular" required placeholder="Nombre completo del titular"
                      class="modal-expert__input">
                    <p class="hint">Debe coincidir con el nombre en la cuenta</p>
                  </div>

                  <div>
                    <label for="tipoDocumento">Tipo de documento *</label>
                    <div id="tipoDocumento-wrapper">
                      <select id="tipoDocumento" name="tipoDocumento" required class="modal-expert__input">
                        <option value="">Selecciona el tipo</option>
                        <option value="Cédula de Ciudadanía">Cédula de Ciudadanía</option>
                        <option value="Cédula de Extranjería">Cédula de Extranjería</option>
                        <option value="Pasaporte">Pasaporte</option>
                        <option value="NIT">NIT (Persona Jurídica)</option>
                      </select>
                    </div>
                  </div>

                  <div>
                    <label for="numeroDocumento">Número de documento *</label>
                    <input type="text" id="numeroDocumento" name="numeroDocumento" required
                      placeholder="Número de identificación" pattern="[0-9\-]*" class="modal-expert__input">
                    <p class="hint">Documento del titular</p>
                  </div>

                  <div class="full-width">
                    <label for="telefonoContacto">Teléfono de contacto</label>
                    <input type="tel" id="telefonoContacto" name="telefonoContacto" placeholder="+57 300 123 4567"
                      class="modal-expert__input">
                    <p class="hint">Opcional: Teléfono para contacto sobre pagos</p>
                  </div>
                </div>

                <div class="info-box info-sm">
                  <div class="info-header">
                    <i class="fas fa-info-circle"></i>
                    <strong>Información importante sobre pagos</strong>
                  </div>
                  <ul class="info-list">
                    <li><i class="fas fa-check"></i> Los pagos se procesan cada 15 días</li>
                    <li><i class="fas fa-check"></i> Se requiere verificación de cuenta</li>
                    <li><i class="fas fa-check"></i> Datos editables desde tu perfil</li>
                    <li><i class="fas fa-check"></i> Seguridad garantizada</li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </form>

        <!-- DEBUG: Botón temporal para testing -->
        <div style="margin-top: 20px; padding: 10px; background: #333; border-radius: 5px;">
          <button type="button" onclick="window.forceInitChoices()"
            style="background: #007bff; color: white; border: none; padding: 8px 16px; border-radius: 4px; margin-right: 10px;">
            🔧 Forzar Init Choices.js
          </button>
          <button type="button" onclick="console.log('Window.Choices:', !!window.Choices)"
            style="background: #28a745; color: white; border: none; padding: 8px 16px; border-radius: 4px; margin-right: 10px;">
            ✅ Test Choices.js
          </button>
          <button type="button" onclick="console.log('Habilidades select:', document.getElementById('habilidades'))"
            style="background: #ffc107; color: black; border: none; padding: 8px 16px; border-radius: 4px;">
            📋 Test Elemento
          </button>
          <button type="button" onclick="initializeHabilidadesDirectly()"
            style="background: #dc3545; color: white; border: none; padding: 8px 16px; border-radius: 4px; margin-left: 10px;">
            🚨 Init Habilidades DIRECTO
          </button>
        </div>

        <script>
          // Función de emergencia para inicializar habilidades directamente
          function initializeHabilidadesDirectly() {
            console.log('🚨 Inicializando habilidades DIRECTAMENTE...');

            const habilidadesSelect = document.getElementById('habilidades');
            if (!habilidadesSelect) {
              console.error('❌ No se encontró el select de habilidades');
              return;
            }

            if (!window.Choices) {
              console.error('❌ Choices.js no está disponible');
              return;
            }

            try {
              // Destruir instancia previa si existe
              if (habilidadesSelect.choices) {
                habilidadesSelect.choices.destroy();
              }

              // Crear nueva instancia
              const choicesInstance = new Choices(habilidadesSelect, {
                allowHTML: true,
                removeItemButton: true,
                placeholderValue: 'Selecciona habilidades',
                searchPlaceholderValue: 'Buscar habilidades...',
                noResultsText: 'No se encontraron resultados',
                itemSelectText: 'Presiona para seleccionar',
                duplicateItemsAllowed: false,
                searchEnabled: true
              });

              habilidadesSelect.classList.add('choices-initialized');
              console.log('✅ Habilidades inicializadas DIRECTAMENTE!');

              return choicesInstance;
            } catch (error) {
              console.error('❌ Error en inicialización directa:', error);
            }
          }
        </script>
      </div>

      <!-- Moved footer inside container so it remains visually part of the modal.
                 The container is a column-flex so the body scrolls while footer stays at bottom. -->
      <div class="modal-expert__footer">
        <button class="btn-outline" data-dismiss="modal" type="button">Cancelar</button>
        <button type="button" class="btn-primary" id="saveExpert">Guardar experto</button>
      </div>
    </div>
  </div>

  <!--modal editar experto-->
  <div id="editarExperto" class="modal-expert" style="display:none;">

    <div class="modal-expert__container">
      <div class="modal-expert__header">
        <h2 class="modal-expert__title">Editar experto</h2>
        <button class="btn-close" aria-label="Cerrar"><i class="fas fa-times"></i></button>
      </div>

      <div class="modal-expert__body">
        <form id="expertForm">
          <!-- Layout helper: responsive two-column grid for most rows -->
          <div class="modal-expert__grid">

            <!-- Información básica -->
            <div>
              <label class="modal-expert__label" for="name">
                <i class="fas fa-user modal-expert__icon" aria-hidden="true"></i>
                Nombre completo
              </label>
              <input type="text" id="name" placeholder="Nombre y apellidos registrados" class="modal-expert__input" />
            </div>

            <div>
              <label class="modal-expert__label" for="email">
                <i class="fas fa-envelope modal-expert__icon" aria-hidden="true"></i>
                Email registrado
              </label>
              <input type="email" id="email" placeholder="Email de la cuenta" class="modal-expert__input" />
            </div>

            <!-- Precio por hora (columna) -->
            <div>
              <label for="precio" class="modal-expert__label">
                <i class="fas fa-money-bill-wave modal-expert__icon" aria-hidden="true" title="Precio"></i>
                Precio por hora (COP)
                <span class="price-tooltip icon-tooltip" title="Ejemplo recomendado: $30.000 - $200.000 COP"
                  style="margin-left:.5rem;">
                  <i class="fas fa-info-circle"></i>
                </span>
              </label>

              <div class="srv-price-input price-input">
                <span class="srv-currency currency-symbol">$</span>
                <input type="number" id="precio" name="precio" min="10000" step="100" required placeholder="Ej: 50000"
                  class="srv-input price-field" />
              </div>
              <p class="srv-note price-note">
                Tarifa por hora de asesoría (Recomendado: $30.000 - $200.000 COP)
              </p>
              <div id="precio-feedback" class="srv-feedback price-feedback" aria-live="polite"></div>
            </div>

            <!-- Días disponibles (columna) -->
            <div>
              <label for="diasDisponibles" class="modal-expert__label">
                <i class="fas fa-calendar-alt modal-expert__icon" aria-hidden="true"></i>
                Días disponibles
              </label>

              <div class="srv-days-wrapper">
                <div class="srv-days">
                  <button type="button" class="srv-day" data-day="Lunes" aria-pressed="false">L</button>
                  <button type="button" class="srv-day" data-day="Martes" aria-pressed="false">M</button>
                  <button type="button" class="srv-day" data-day="Miércoles" aria-pressed="false">X</button>
                  <button type="button" class="srv-day" data-day="Jueves" aria-pressed="false">J</button>
                  <button type="button" class="srv-day" data-day="Viernes" aria-pressed="false">V</button>
                  <button type="button" class="srv-day" data-day="Sábado" aria-pressed="false">S</button>
                  <button type="button" class="srv-day" data-day="Domingo" aria-pressed="false">D</button>
                </div>

                <div class="srv-days-display">
                  Ningún día seleccionado
                </div>
              </div>

              <input type="hidden" id="diasDisponibles" name="diasDisponibles" />
            </div>

            <!-- Especialidad principal -->
            <div>
              <label class="modal-expert__label" for="specialty">
                <i class="fas fa-briefcase modal-expert__icon" aria-hidden="true"></i>
                Especialidad principal
              </label>
              <div class="input-with-icon">
                <select id="specialty" class="modal-expert__input modal-expert__select"
                  aria-label="Especialidad principal">
                  <option value="">Seleccionar especialidad</option>
                  <option value="web">Desarrollo Web</option>
                  <option value="mobile">Desarrollo Móvil</option>
                  <option value="data">Ciencia de Datos</option>
                  <option value="uxui">UX/UI</option>
                  <option value="devops">DevOps</option>
                  <option value="blockchain">Blockchain</option>
                  <option value="cloud">Cloud Computing</option>
                </select>
              </div>
              <small class="modal-expert__hint">Selecciona la especialidad principal que describe mejor al
                experto</small>
            </div>

            <!-- Estado -->
            <div>
              <label class="modal-expert__label" for="status">
                <i class="fas fa-toggle-on modal-expert__icon" aria-hidden="true"></i>
                Estado
              </label>
              <div class="input-with-icon">
                <select id="status" class="modal-expert__input modal-expert__select" aria-label="Estado del experto">
                  <option value="active">Activo</option>
                  <option value="pending">Pendiente</option>
                  <option value="inactive">Inactivo</option>
                </select>
              </div>
              <small class="modal-expert__hint">Define si el experto puede recibir solicitudes</small>
            </div>

            <!-- Categorías (full width) -->
            <div class="full-width">
              <label class="modal-expert__label" for="edit_categorias">
                <i class="fas fa-tags modal-expert__icon" aria-hidden="true"></i>
                Categorías
              </label>
              <select id="edit_categorias" class="modal-expert__input modal-expert__select-categorias" multiple size="4"
                aria-label="Categorías">
                <% if (typeof categorias !=='undefined' && Array.isArray(categorias) && categorias.length> 0) { %>
                  <% categorias.forEach(function(c) { %>
                    <% const catId=(c && c._id) ? String(c._id) : (c && (c.nombre || c.name || c.label) ? (c.nombre ||
                      c.name || c.label) : '' ); %>
                      <% const catLabel=(c && (c.nombre || c.name || c.label)) ? (c.nombre || c.name || c.label) :
                        catId; %>
                        <% if (catId) { %>
                          <option value="<%= catId %>">
                            <%= catLabel %>
                          </option>
                          <% } %>
                            <% }); %>
                              <% } %>
              </select>
              <small class="modal-expert__hint">Selecciona una o varias categorías (Ctrl/Cmd+click)</small>
            </div>

            <!-- Habilidades (full width) -->
            <div class="full-width">
              <label class="modal-expert__label" for="editSkills">
                <i class="fas fa-tools modal-expert__icon" aria-hidden="true"></i>
                Habilidades
              </label>
              <select id="editSkills" class="modal-expert__input" multiple size="6">
                <% if (typeof habilidades !=='undefined' && Array.isArray(habilidades) && habilidades.length> 0) { %>
                  <% habilidades.forEach(function(h) { %>
                    <% const val=(h && (h.nombre || h.name || h.label)) ? (h.nombre || h.name || h.label) : (h && h._id
                      ? String(h._id) : '' ); %>
                      <% if (val) { %>
                        <option value="<%= val %>">
                          <%= val %>
                        </option>
                        <% } %>
                          <% }); %>
                            <% } %>
              </select>
              <small class="modal-expert__hint">Selecciona o escribe para añadir nuevas habilidades</small>
            </div>

            <!-- Biografía -->
            <div class="full-width">
              <label class="modal-expert__label" for="bio">
                <i class="fas fa-file-alt modal-expert__icon" aria-hidden="true"></i>
                Biografía profesional
              </label>
              <textarea id="bio" rows="4" placeholder="Descripción breve de experiencia y especialización"
                class="modal-expert__input modal-expert__textarea"></textarea>
            </div>

            <!-- Imagen de perfil -->
            <div class="full-width">
              <label class="modal-expert__label" for="profileImage">
                <i class="fas fa-image modal-expert__icon" aria-hidden="true"></i>
                Imagen de perfil
              </label>

              <div class="modal-expert__upload-wrapper">
                <!-- hidden but accessible -->
                <input type="file" id="profileImage" class="modal-expert__file-input"
                  aria-label="Seleccionar imagen de perfil" accept="image/*" />

                <!-- visual upload box (acts as label) -->
                <label for="profileImage" class="modal-expert__upload-box" role="button" aria-haspopup="dialog">
                  <i class="fas fa-upload" aria-hidden="true"></i>
                  <span id="uploadLabel">Seleccionar imagen (png, jpg) · Máx 2MB</span>
                </label>

                <!-- preview thumbnail -->
                <div id="profilePreview" aria-hidden="true" role="img" aria-label="Vista previa de imagen">
                  <button id="removeProfileBtn" type="button" title="Eliminar imagen" aria-label="Eliminar imagen"
                    style="display:none;">
                    <i class="fas fa-times"></i>
                  </button>
                  <img src="" alt="Preview" />
                </div>

                <div class="upload-meta" id="uploadMeta" aria-live="polite" style="display:none;"></div>
                <div class="upload-error" id="profileImageError" role="alert" style="display:none;"></div>
              </div>
            </div>

            <!-- Espacio reservado para mantener la columna alineada -->
            <div aria-hidden="true"></div>

            <!-- Sección bancaria (tarjeta de ancho completo) -->
            <div class="full-width">
              <div class="bank-section">
                <h3 class="bank-title">
                  <i class="fas fa-university"></i> Datos Bancarios para Pagos
                </h3>
                <p class="bank-sub">Información necesaria para recibir pagos por tus asesorías</p>

                <div class="bank-grid">
                  <div>
                    <label for="banco">Banco *</label>
                    <div id="banco-wrapper">
                      <select id="banco" name="banco" required class="modal-expert__input">
                        <option value="">Selecciona tu banco</option>
                        <option value="Banco de Bogotá">Banco de Bogotá</option>
                        <option value="Bancolombia">Bancolombia</option>
                        <option value="Banco Popular">Banco Popular</option>
                        <option value="Banco AV Villas">Banco AV Villas</option>
                        <option value="Banco Caja Social">Banco Caja Social</option>
                        <option value="Banco de Occidente">Banco de Occidente</option>
                        <option value="Banco GNB Sudameris">Banco GNB Sudameris</option>
                        <option value="Banco Itaú">Banco Itaú</option>
                        <option value="Banco Pichincha">Banco Pichincha</option>
                        <option value="Banco Santander">Banco Santander</option>
                        <option value="Banco Scotiabank Colpatria">Banco Scotiabank Colpatria</option>
                        <option value="Davivienda">Davivienda</option>
                        <option value="Banco Agrario">Banco Agrario</option>
                        <option value="Banco Falabella">Banco Falabella</option>
                        <option value="Banco Finandina">Banco Finandina</option>
                        <option value="Banco W">Banco W</option>
                        <option value="Banco Serfinanza">Banco Serfinanza</option>
                        <option value="Banco Cooperativo Coopcentral">Banco Cooperativo Coopcentral</option>
                        <option value="Banco BBVA">Banco BBVA</option>
                        <option value="Nequi">Nequi</option>
                        <option value="Daviplata">Daviplata</option>
                        <option value="Movii">Movii</option>
                        <option value="Banco de Vivienda">Banco de Vivienda</option>
                        <option value="Banco ProCredit">Banco ProCredit</option>
                        <option value="Banco Multibank">Banco Multibank</option>
                        <option value="Banco Coopcentral">Banco Coopcentral</option>
                        <option value="Banco Credifinanciera">Banco Credifinanciera</option>
                        <option value="Banco Mundo Mujer">Banco Mundo Mujer</option>
                        <option value="Banco Ripley">Banco Ripley</option>
                        <option value="Banco CrediScotia">Banco CrediScotia</option>
                      </select>
                    </div>
                  </div>

                  <div>
                    <label for="tipoCuenta">Tipo de cuenta *</label>
                    <div id="tipoCuenta-wrapper">
                      <select id="tipoCuenta" name="tipoCuenta" required class="modal-expert__input">
                        <option value="">Selecciona el tipo</option>
                        <option value="Cuenta de Ahorros">Cuenta de Ahorros</option>
                        <option value="Cuenta Corriente">Cuenta Corriente</option>
                        <option value="Cuenta de Nómina">Cuenta de Nómina</option>
                        <option value="Cuenta Digital">Cuenta Digital</option>
                      </select>
                    </div>
                  </div>

                  <div>
                    <label for="numeroCuenta">Número de cuenta *</label>
                    <div class="acct-wrap">
                      <input type="password" id="numeroCuenta" name="numeroCuenta" required
                        placeholder="Número de cuenta" pattern="[0-9\-]*" title="Solo números y guiones"
                        class="acct-input">
                      <button type="button" id="toggleAccountNumber" class="acct-toggle"
                        aria-label="Mostrar número de cuenta">
                        <i class="fas fa-eye"></i>
                      </button>
                    </div>
                    <p class="hint">Número completo de tu cuenta</p>
                  </div>

                  <div>
                    <label for="titular">Titular de la cuenta *</label>
                    <input type="text" id="titular" name="titular" required placeholder="Nombre completo del titular"
                      class="modal-expert__input">
                    <p class="hint">Debe coincidir con el nombre en la cuenta</p>
                  </div>

                  <div>
                    <label for="tipoDocumento">Tipo de documento *</label>
                    <div id="tipoDocumento-wrapper">
                      <select id="tipoDocumento" name="tipoDocumento" required class="modal-expert__input">
                        <option value="">Selecciona el tipo</option>
                        <option value="Cédula de Ciudadanía">Cédula de Ciudadanía</option>
                        <option value="Cédula de Extranjería">Cédula de Extranjería</option>
                        <option value="Pasaporte">Pasaporte</option>
                        <option value="NIT">NIT (Persona Jurídica)</option>
                      </select>
                    </div>
                  </div>

                  <div>
                    <label for="numeroDocumento">Número de documento *</label>
                    <input type="text" id="numeroDocumento" name="numeroDocumento" required
                      placeholder="Número de identificación" pattern="[0-9\-]*" class="modal-expert__input">
                    <p class="hint">Documento del titular</p>
                  </div>

                  <div class="full-width">
                    <label for="telefonoContacto">Teléfono de contacto</label>
                    <input type="tel" id="telefonoContacto" name="telefonoContacto" placeholder="+57 300 123 4567"
                      class="modal-expert__input">
                    <p class="hint">Opcional: Teléfono para contacto sobre pagos</p>
                  </div>
                </div>

                <div class="info-box info-sm">
                  <div class="info-header">
                    <i class="fas fa-info-circle"></i>
                    <strong>Información importante sobre pagos</strong>
                  </div>
                  <ul class="info-list">
                    <li><i class="fas fa-check"></i> Los pagos se procesan cada 15 días</li>
                    <li><i class="fas fa-check"></i> Se requiere verificación de cuenta</li>
                    <li><i class="fas fa-check"></i> Datos editables desde tu perfil</li>
                    <li><i class="fas fa-check"></i> Seguridad garantizada</li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </form>
      </div>

      <!-- Moved footer inside container so it remains visually part of the modal.
             The container is a column-flex so the body scrolls while footer stays at bottom. -->
      <div class="modal-expert__footer">
        <button class="btn-outline" data-dismiss="modal" type="button">Cancelar</button>
        <button type="button" class="btn-primary" id="saveExpert">Guardar experto</button>
      </div>
    </div>
  </div>

  <!--modal ver perfil experto-->
  <div id="verPerfilExperto" class="modal-expert" style="display:none;">

    <div class="modal-expert__container">
      <div class="modal-expert__header">
        <h2 class="modal-expert__title">Perfil del experto</h2>
        <button class="btn-close" aria-label="Cerrar"><i class="fas fa-times"></i></button>
      </div>

      <div class="modal-expert__body">
        <form id="ver_expertForm">
          <!-- Layout helper: responsive two-column grid for most rows -->
          <div class="modal-expert__grid">

            <!-- Información básica -->
            <div>
              <label class="modal-expert__label" for="ver_name">
                <i class="fas fa-user modal-expert__icon" aria-hidden="true"></i>
                Nombre completo
              </label>
              <input type="text" id="ver_name" placeholder="Nombre y apellidos registrados" class="modal-expert__input"
                readonly />
            </div>

            <div>
              <label class="modal-expert__label" for="ver_email">
                <i class="fas fa-envelope modal-expert__icon" aria-hidden="true"></i>
                Email registrado
              </label>
              <input type="email" id="ver_email" placeholder="Email de la cuenta" class="modal-expert__input"
                readonly />
            </div>

            <!-- Precio por hora (columna) -->
            <div>
              <label for="ver_precio" class="modal-expert__label">
                <i class="fas fa-money-bill-wave modal-expert__icon" aria-hidden="true" title="Precio"></i>
                Precio por hora (COP)
                <span class="price-tooltip icon-tooltip" title="Ejemplo recomendado: $30.000 - $200.000 COP"
                  style="margin-left:.5rem;">
                  <i class="fas fa-info-circle"></i>
                </span>
              </label>

              <div class="srv-price-input price-input">
                <span class="srv-currency currency-symbol">$</span>
                <input type="number" id="ver_precio" name="ver_precio" min="10000" step="100" placeholder="Ej: 50000"
                  class="srv-input price-field" readonly />
              </div>
              <p class="srv-note price-note">
                Tarifa por hora de asesoría (Recomendado: $30.000 - $200.000 COP)
              </p>
              <div id="ver_precio-feedback" class="srv-feedback price-feedback" aria-live="polite"></div>
            </div>

            <!-- Días disponibles (columna) -->
            <div>
              <label for="ver_diasDisponibles" class="modal-expert__label">
                <i class="fas fa-calendar-alt modal-expert__icon" aria-hidden="true"></i>
                Días disponibles
              </label>

              <div class="srv-days-wrapper">
                <div class="srv-days">
                  <button type="button" class="srv-day" data-day="Lunes" aria-pressed="false" disabled>L</button>
                  <button type="button" class="srv-day" data-day="Martes" aria-pressed="false" disabled>M</button>
                  <button type="button" class="srv-day" data-day="Miércoles" aria-pressed="false" disabled>X</button>
                  <button type="button" class="srv-day" data-day="Jueves" aria-pressed="false" disabled>J</button>
                  <button type="button" class="srv-day" data-day="Viernes" aria-pressed="false" disabled>V</button>
                  <button type="button" class="srv-day" data-day="Sábado" aria-pressed="false" disabled>S</button>
                  <button type="button" class="srv-day" data-day="Domingo" aria-pressed="false" disabled>D</button>
                </div>

                <div class="srv-days-display">
                  Ningún día seleccionado
                </div>
              </div>

              <input type="hidden" id="ver_diasDisponibles" name="ver_diasDisponibles" />
            </div>

            <!-- Especialidad principal -->
            <div>
              <label class="modal-expert__label" for="ver_specialty">
                <i class="fas fa-briefcase modal-expert__icon" aria-hidden="true"></i>
                Especialidad principal
              </label>
              <div class="input-with-icon">
                <select id="ver_specialty" class="modal-expert__input modal-expert__select"
                  aria-label="Especialidad principal" disabled>
                  <option value="">Seleccionar especialidad</option>
                  <option value="web">Desarrollo Web</option>
                  <option value="mobile">Desarrollo Móvil</option>
                  <option value="data">Ciencia de Datos</option>
                  <option value="uxui">UX/UI</option>
                  <option value="devops">DevOps</option>
                  <option value="blockchain">Blockchain</option>
                  <option value="cloud">Cloud Computing</option>
                </select>
              </div>
              <small class="modal-expert__hint">Selecciona la especialidad principal que describe mejor al
                experto</small>
            </div>

            <!-- Estado -->
            <div>
              <label class="modal-expert__label" for="ver_status">
                <i class="fas fa-toggle-on modal-expert__icon" aria-hidden="true"></i>
                Estado
              </label>
              <div class="input-with-icon">
                <select id="ver_status" class="modal-expert__input modal-expert__select" aria-label="Estado del experto"
                  disabled>
                  <option value="active">Activo</option>
                  <option value="pending">Pendiente</option>
                  <option value="inactive">Inactivo</option>
                </select>
              </div>
              <small class="modal-expert__hint">Define si el experto puede recibir solicitudes</small>
            </div>

            <!-- Categorías (full width) -->
            <div class="full-width">
              <label class="modal-expert__label" for="ver_categorias">
                <i class="fas fa-tags modal-expert__icon" aria-hidden="true"></i>
                Categorías
              </label>
              <select id="ver_categorias" class="modal-expert__input modal-expert__select-categorias" multiple size="4"
                aria-label="Categorías" disabled>
                <% if (typeof categorias !=='undefined' && Array.isArray(categorias) && categorias.length> 0) { %>
                  <% categorias.forEach(function(c) { %>
                    <% const catId=(c && c._id) ? String(c._id) : (c && (c.nombre || c.name || c.label) ? (c.nombre ||
                      c.name || c.label) : '' ); %>
                      <% const catLabel=(c && (c.nombre || c.name || c.label)) ? (c.nombre || c.name || c.label) :
                        catId; %>
                        <% if (catId) { %>
                          <option value="<%= catId %>">
                            <%= catLabel %>
                          </option>
                          <% } %>
                            <% }); %>
                              <% } %>
              </select>
              <small class="modal-expert__hint">Selecciona una o varias categorías (Ctrl/Cmd+click)</small>
            </div>

            <!-- Habilidades (full width) -->
            <div class="full-width">
              <label class="modal-expert__label" for="ver_habilidades">
                <i class="fas fa-tools modal-expert__icon" aria-hidden="true"></i>
                Habilidades
              </label>
              <select id="ver_habilidades" class="modal-expert__input" multiple size="6">
                <% if (typeof habilidades !=='undefined' && Array.isArray(habilidades) && habilidades.length> 0) { %>
                  <% habilidades.forEach(function(h) { %>
                    <% const val=(h && (h.nombre || h.name || h.label)) ? (h.nombre || h.name || h.label) : (h && h._id
                      ? String(h._id) : '' ); %>
                      <% if (val) { %>
                        <option value="<%= val %>">
                          <%= val %>
                        </option>
                        <% } %>
                          <% }); %>
                            <% } %>
              </select>
              <small class="modal-expert__hint">Selecciona o escribe para añadir nuevas habilidades</small>
            </div>

            <!-- Biografía -->
            <div class="full-width">
              <label class="modal-expert__label" for="bio">
                <i class="fas fa-file-alt modal-expert__icon" aria-hidden="true"></i>
                Biografía profesional
              </label>
              <textarea id="bio" rows="4" placeholder="Descripción breve de experiencia y especialización"
                class="modal-expert__input modal-expert__textarea"></textarea>
            </div>

            <!-- Imagen de perfil -->
            <div class="full-width">
              <label class="modal-expert__label" for="profileImage">
                <i class="fas fa-image modal-expert__icon" aria-hidden="true"></i>
                Imagen de perfil
              </label>

              <div class="modal-expert__upload-wrapper">
                <!-- hidden but accessible -->
                <input type="file" id="profileImage" class="modal-expert__file-input"
                  aria-label="Seleccionar imagen de perfil" accept="image/*" />

                <!-- visual upload box (acts as label) -->
                <label for="profileImage" class="modal-expert__upload-box" role="button" aria-haspopup="dialog">
                  <i class="fas fa-upload" aria-hidden="true"></i>
                  <span id="uploadLabel">Seleccionar imagen (png, jpg) · Máx 2MB</span>
                </label>

                <!-- preview thumbnail -->
                <div id="profilePreview" aria-hidden="true" role="img" aria-label="Vista previa de imagen">
                  <button id="removeProfileBtn" type="button" title="Eliminar imagen" aria-label="Eliminar imagen"
                    style="display:none;">
                    <i class="fas fa-times"></i>
                  </button>
                  <img src="" alt="Preview" />
                </div>

                <div class="upload-meta" id="uploadMeta" aria-live="polite" style="display:none;"></div>
                <div class="upload-error" id="profileImageError" role="alert" style="display:none;"></div>
              </div>
            </div>

            <!-- Espacio reservado para mantener la columna alineada -->
            <div aria-hidden="true"></div>

            <!-- Sección bancaria (tarjeta de ancho completo) -->
            <div class="full-width">
              <div class="bank-section">
                <h3 class="bank-title">
                  <i class="fas fa-university"></i> Datos Bancarios para Pagos
                </h3>
                <p class="bank-sub">Información necesaria para recibir pagos por tus asesorías</p>

                <div class="bank-grid">
                  <div>
                    <label for="banco">Banco *</label>
                    <div id="banco-wrapper">
                      <select id="banco" name="banco" required class="modal-expert__input">
                        <option value="">Selecciona tu banco</option>
                        <option value="Banco de Bogotá">Banco de Bogotá</option>
                        <option value="Bancolombia">Bancolombia</option>
                        <option value="Banco Popular">Banco Popular</option>
                        <option value="Banco AV Villas">Banco AV Villas</option>
                        <option value="Banco Caja Social">Banco Caja Social</option>
                        <option value="Banco de Occidente">Banco de Occidente</option>
                        <option value="Banco GNB Sudameris">Banco GNB Sudameris</option>
                        <option value="Banco Itaú">Banco Itaú</option>
                        <option value="Banco Pichincha">Banco Pichincha</option>
                        <option value="Banco Santander">Banco Santander</option>
                        <option value="Banco Scotiabank Colpatria">Banco Scotiabank Colpatria</option>
                        <option value="Davivienda">Davivienda</option>
                        <option value="Banco Agrario">Banco Agrario</option>
                        <option value="Banco Falabella">Banco Falabella</option>
                        <option value="Banco Finandina">Banco Finandina</option>
                        <option value="Banco W">Banco W</option>
                        <option value="Banco Serfinanza">Banco Serfinanza</option>
                        <option value="Banco Cooperativo Coopcentral">Banco Cooperativo Coopcentral</option>
                        <option value="Banco BBVA">Banco BBVA</option>
                        <option value="Nequi">Nequi</option>
                        <option value="Daviplata">Daviplata</option>
                        <option value="Movii">Movii</option>
                        <option value="Banco de Vivienda">Banco de Vivienda</option>
                        <option value="Banco ProCredit">Banco ProCredit</option>
                        <option value="Banco Multibank">Banco Multibank</option>
                        <option value="Banco Coopcentral">Banco Coopcentral</option>
                        <option value="Banco Credifinanciera">Banco Credifinanciera</option>
                        <option value="Banco Mundo Mujer">Banco Mundo Mujer</option>
                        <option value="Banco Ripley">Banco Ripley</option>
                        <option value="Banco CrediScotia">Banco CrediScotia</option>
                      </select>
                    </div>
                  </div>

                  <div>
                    <label for="tipoCuenta">Tipo de cuenta *</label>
                    <div id="tipoCuenta-wrapper">
                      <select id="tipoCuenta" name="tipoCuenta" required class="modal-expert__input">
                        <option value="">Selecciona el tipo</option>
                        <option value="Cuenta de Ahorros">Cuenta de Ahorros</option>
                        <option value="Cuenta Corriente">Cuenta Corriente</option>
                        <option value="Cuenta de Nómina">Cuenta de Nómina</option>
                        <option value="Cuenta Digital">Cuenta Digital</option>
                      </select>
                    </div>
                  </div>

                  <div>
                    <label for="numeroCuenta">Número de cuenta *</label>
                    <div class="acct-wrap">
                      <input type="password" id="numeroCuenta" name="numeroCuenta" required
                        placeholder="Número de cuenta" pattern="[0-9\-]*" title="Solo números y guiones"
                        class="acct-input">
                      <button type="button" id="toggleAccountNumber" class="acct-toggle"
                        aria-label="Mostrar número de cuenta">
                        <i class="fas fa-eye"></i>
                      </button>
                    </div>
                    <p class="hint">Número completo de tu cuenta</p>
                  </div>

                  <div>
                    <label for="titular">Titular de la cuenta *</label>
                    <input type="text" id="titular" name="titular" required placeholder="Nombre completo del titular"
                      class="modal-expert__input">
                    <p class="hint">Debe coincidir con el nombre en la cuenta</p>
                  </div>

                  <div>
                    <label for="tipoDocumento">Tipo de documento *</label>
                    <div id="tipoDocumento-wrapper">
                      <select id="tipoDocumento" name="tipoDocumento" required class="modal-expert__input">
                        <option value="">Selecciona el tipo</option>
                        <option value="Cédula de Ciudadanía">Cédula de Ciudadanía</option>
                        <option value="Cédula de Extranjería">Cédula de Extranjería</option>
                        <option value="Pasaporte">Pasaporte</option>
                        <option value="NIT">NIT (Persona Jurídica)</option>
                      </select>
                    </div>
                  </div>

                  <div>
                    <label for="numeroDocumento">Número de documento *</label>
                    <input type="text" id="numeroDocumento" name="numeroDocumento" required
                      placeholder="Número de identificación" pattern="[0-9\-]*" class="modal-expert__input">
                    <p class="hint">Documento del titular</p>
                  </div>

                  <div class="full-width">
                    <label for="telefonoContacto">Teléfono de contacto</label>
                    <input type="tel" id="telefonoContacto" name="telefonoContacto" placeholder="+57 300 123 4567"
                      class="modal-expert__input">
                    <p class="hint">Opcional: Teléfono para contacto sobre pagos</p>
                  </div>
                </div>

                <div class="info-box info-sm">
                  <div class="info-header">
                    <i class="fas fa-info-circle"></i>
                    <strong>Información importante sobre pagos</strong>
                  </div>
                  <ul class="info-list">
                    <li><i class="fas fa-check"></i> Los pagos se procesan cada 15 días</li>
                    <li><i class="fas fa-check"></i> Se requiere verificación de cuenta</li>
                    <li><i class="fas fa-check"></i> Datos editables desde tu perfil</li>
                    <li><i class="fas fa-check"></i> Seguridad garantizada</li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </form>
      </div>

      <!-- Moved footer inside container so it remains visually part of the modal.
               The container is a column-flex so the body scrolls while footer stays at bottom. -->
      <div class="modal-expert__footer">
        <button class="btn-outline" data-dismiss="modal" type="button">Cerrar</button>
        <button type="button" class="btn-primary" id="editExpertFromView">Editar experto</button>
      </div>
    </div>
  </div>

  <!-- Modal inactivar experto -->
  <div id="modalInactivarExperto" class="modal-expert">
    <div class="modal-expert__content">
      <div class="modal-expert__header">
        <h2 class="modal-expert__title">Inactivar experto</h2>
        <button class="btn-close"><i class="fas fa-times"></i></button>
      </div>
      <div class="modal-expert__body">
        <p id="modalInactivarExpertoNombre" class="modal-expert__nombre-destacado"></p>
        <p>
          ¿Está seguro que desea inactivar este usuario?<br />
          <span class="modal-expert__texto-secundario">
            El usuario <b>no se eliminará</b> de la base de datos, solo pasará
            a estado <b>inactivo</b>.
          </span>
        </p>
      </div>
      <div class="modal-expert__footer">
        <button type="button" class="btn-outline modal-inactivar-cancelar">
          Cancelar
        </button>
        <button type="button" class="btn-primary modal-inactivar-confirmar">
          Inactivar
        </button>
      </div>
    </div>
  </div>

  <!-- Choices.js library para campos de selección múltiple -->
  <script src="https://cdn.jsdelivr.net/npm/choices.js@10.2.0/public/assets/scripts/choices.min.js"></script>

  <!-- Script para inicializar Choices.js -->
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      console.log('🚀 Sistema centralizado de Choices.js iniciado');

      // TEST INMEDIATO: Verificar Choices.js
      console.log('🔍 Test de Choices.js:', {
        libraryAvailable: typeof Choices !== 'undefined',
        libraryVersion: typeof Choices !== 'undefined' ? Choices.VERSION || 'unknown' : 'N/A'
      });

      if (typeof Choices === 'undefined') {
        console.error('❌ PROBLEMA: Choices.js no está cargado!');
        return;
      }

      // TEST: Inicializar habilidades inmediatamente para debug
      setTimeout(function () {
        const habilidadesSelect = document.getElementById('habilidades');
        console.log('🔍 Estado del select habilidades:', {
          exists: !!habilidadesSelect,
          isVisible: habilidadesSelect ? habilidadesSelect.offsetParent !== null : false,
          hasOptions: habilidadesSelect ? habilidadesSelect.options.length : 0,
          multiple: habilidadesSelect ? habilidadesSelect.multiple : false,
          className: habilidadesSelect ? habilidadesSelect.className : 'N/A'
        });

        if (habilidadesSelect && habilidadesSelect.options.length > 0) {
          console.log('🔧 TEST: Forzando Choices.js en habilidades...');

          try {
            // Limpiar cualquier instancia previa
            if (habilidadesSelect.choices) {
              habilidadesSelect.choices.destroy();
            }

            const choicesInstance = new Choices(habilidadesSelect, {
              allowHTML: true,
              removeItemButton: true,
              placeholderValue: 'Selecciona habilidades...',
              searchPlaceholderValue: 'Buscar habilidades...',
              noResultsText: 'No se encontraron resultados',
              itemSelectText: 'Presiona para seleccionar',
              duplicateItemsAllowed: false,
              searchEnabled: true
            });

            habilidadesSelect.classList.add('choices-initialized');
            console.log('✅ TEST EXITOSO: Habilidades con Choices.js funcionando!');

          } catch (error) {
            console.error('❌ TEST FALLIDO:', error);
          }
        } else {
          console.warn('⚠️ Select habilidades no está listo para Choices.js');
        }
      }, 2000); // Dar tiempo suficiente para que todo cargue

      // Debug específico: mostrar qué datos llegaron del servidor
      console.log('📊 Datos del servidor:');
      console.log('  Categorías:', JSON.parse('<%- JSON.stringify(JSON.stringify(categorias || [])) %>'));
      console.log('  Habilidades:', JSON.parse('<%- JSON.stringify(JSON.stringify(habilidades || [])) %>'));

      // Mapeo de IDs a configuraciones específicas
      const fieldConfigurations = {
        // Modal agregar experto
        'categorias': {
          type: 'categories',
          placeholder: 'Selecciona categorías',
          searchPlaceholder: 'Buscar categorías...',
          modal: '#expertModal'
        },
        'habilidades': {
          type: 'skills',
          placeholder: 'Selecciona habilidades',
          searchPlaceholder: 'Buscar habilidades...',
          modal: '#expertModal'
        },
        // Modal editar experto
        'edit_categorias': {
          type: 'categories',
          placeholder: 'Selecciona categorías',
          searchPlaceholder: 'Buscar categorías...',
          modal: '#editExpertModal'
        },
        'editSkills': {
          type: 'skills',
          placeholder: 'Selecciona habilidades',
          searchPlaceholder: 'Buscar habilidades...',
          modal: '#editExpertModal'
        },
        // Modal ver experto
        'ver_categorias': {
          type: 'categories',
          placeholder: 'Categorías del experto',
          searchPlaceholder: 'Buscar categorías...',
          modal: '#verPerfilExperto',
          readonly: true
        },
        'ver_habilidades': {
          type: 'skills',
          placeholder: 'Habilidades del experto',
          searchPlaceholder: 'Buscar habilidades...',
          modal: '#verPerfilExperto',
          readonly: true
        }
      };

      // Función centralizada para aplicar estilos CSS
      function applyChoicesStyles(modalSelector) {
        console.log(`🎨 Aplicando estilos CSS para modal: ${modalSelector}`);

        // Solo aplicar clases CSS, no estilos inline para evitar conflictos
        document.querySelectorAll(`${modalSelector} .choices`).forEach(choicesEl => {
          if (choicesEl) {
            choicesEl.classList.add('choices-styled');
          }
        });

        // Verificar que los elementos existan y estén visibles
        const choicesElements = document.querySelectorAll(`${modalSelector} .choices`);
        console.log(`🔍 Elementos Choices encontrados en ${modalSelector}:`, choicesElements.length);

        choicesElements.forEach((el, index) => {
          console.log(`  - Elemento ${index + 1}:`, {
            id: el.id || 'sin-id',
            visible: el.offsetWidth > 0 && el.offsetHeight > 0,
            classes: el.className,
            hasMultiple: el.querySelector('[multiple]') !== null
          });
        });
      }


      // Función para inicializar un campo específico
      function initializeChoicesField(elementId, config) {
        const element = document.getElementById(elementId);

        if (!element) {
          console.warn(`⚠️ Elemento ${elementId} no encontrado`);
          return null;
        }

        if (element.classList.contains('choices-initialized')) {
          console.log(`ℹ️ Elemento ${elementId} ya está inicializado`);
          return null;
        }

        try {
          const choicesConfig = {
            allowHTML: true,
            removeItemButton: !config.readonly,
            placeholderValue: config.placeholder,
            searchPlaceholderValue: config.searchPlaceholder,
            noResultsText: 'No se encontraron resultados',
            itemSelectText: 'Presiona para seleccionar',
            duplicateItemsAllowed: false,
            searchEnabled: true
          };

          if (config.readonly) {
            choicesConfig.searchEnabled = false;
            choicesConfig.removeItemButton = false;
          }

          const choicesInstance = new Choices(element, choicesConfig);
          element.classList.add('choices-initialized');

          console.log(`✅ Choices.js inicializado correctamente para ${elementId} (${config.type})`);

          // Aplicar estilos específicos del modal
          setTimeout(() => applyChoicesStyles(config.modal), 100);
          setTimeout(() => applyChoicesStyles(config.modal), 500);

          return choicesInstance;

        } catch (error) {
          console.error(`❌ Error inicializando Choices.js para ${elementId}:`, error);
          return null;
        }
      }

      // Función principal de inicialización
      function initializeAllChoicesFields() {
        console.log('🔄 Inicializando todos los campos Choices.js...');
        console.log('🔍 Verificando elementos disponibles...');

        Object.keys(fieldConfigurations).forEach(elementId => {
          const element = document.getElementById(elementId);
          console.log(`📋 Elemento ${elementId}:`, {
            exists: !!element,
            hasOptions: element ? element.options.length : 0,
            isVisible: element ? (element.offsetWidth > 0 && element.offsetHeight > 0) : false
          });

          const config = fieldConfigurations[elementId];
          initializeChoicesField(elementId, config);
        });

        // Aplicar estilos para todos los modales
        setTimeout(() => {
          applyChoicesStyles('#expertModal');
          applyChoicesStyles('#editExpertModal');
          applyChoicesStyles('#verPerfilExperto');
        }, 1000);
      }

      // Carga de respaldo: poblar habilidades si llegaron vacías
      async function populateHabilidadesIfEmpty() {
        try {
          const sel = document.getElementById('habilidades');
          if (!sel) {
            console.warn('⚠️ No se encontró el select #habilidades');
            return;
          }
          if (sel.options && sel.options.length > 0) {
            // Ya hay opciones renderizadas por el servidor
            return;
          }
          console.log('🪄 Poblando habilidades desde /api/habilidades (respaldo)...');
          const resp = await fetch('/api/habilidades');
          if (!resp.ok) {
            console.warn('⚠️ No se pudieron obtener habilidades. Status:', resp.status);
            return;
          }
          const list = await resp.json().catch(() => []);
          if (!Array.isArray(list) || list.length === 0) {
            console.warn('⚠️ /api/habilidades devolvió vacío');
            return;
          }
          // Repoblar opciones
          sel.innerHTML = '';
          list.forEach((h) => {
            const val = (h && (h.nombre || h.name || h.label))
              ? (h.nombre || h.name || h.label)
              : (h && h._id ? String(h._id) : '');
            if (val) {
              const opt = document.createElement('option');
              opt.value = val;
              opt.textContent = val;
              sel.appendChild(opt);
            }
          });
          console.log(`✅ Habilidades poblabas: ${sel.options.length}`);
        } catch (e) {
          console.error('❌ Error poblando habilidades de respaldo:', e);
        }
      }

      // Diagnóstico y debugging
      function showDiagnostics() {
        const allSelects = document.querySelectorAll('select[multiple]');
        const habilidadesSelect = document.getElementById('habilidades');

        console.log('📋 Diagnóstico de elementos:', {
          total: allSelects.length,
          initialized: document.querySelectorAll('select[multiple].choices-initialized').length,
          categories: JSON.parse('<%- JSON.stringify(JSON.stringify(categorias || [])) %>').length,
          skills: JSON.parse('<%- JSON.stringify(JSON.stringify(habilidades || [])) %>').length
        });

        console.log('🔍 Estado específico de habilidades:', {
          exists: !!habilidadesSelect,
          hasOptions: habilidadesSelect ? habilidadesSelect.options.length : 0,
          isInitialized: habilidadesSelect ? habilidadesSelect.classList.contains('choices-initialized') : false,
          hasChoicesInstance: habilidadesSelect ? !!habilidadesSelect.choices : false
        });

        if (habilidadesSelect) {
          console.log('📝 Opciones de habilidades:', Array.from(habilidadesSelect.options).map(opt => opt.text));
        }
      }

      // Inicializar inmediatamente
      if (window.Choices) {
        console.log('✅ Choices.js library detectada, inicializando...');
        populateHabilidadesIfEmpty().then(() => {
          initializeAllChoicesFields();
          showDiagnostics();
        });
      } else {
        console.error('❌ Choices.js library no está disponible');
        console.log('🔍 Esperando a que se cargue Choices.js...');

        // Esperar a que se cargue Choices.js
        let attempts = 0;
        const checkChoices = setInterval(() => {
          attempts++;
          if (window.Choices) {
            console.log(`✅ Choices.js cargado después de ${attempts} intentos`);
            clearInterval(checkChoices);
            populateHabilidadesIfEmpty().then(() => {
              initializeAllChoicesFields();
              showDiagnostics();
            });
          } else if (attempts > 50) {
            console.error('❌ Timeout esperando Choices.js');
            clearInterval(checkChoices);
          }
        }, 100);
      }

      // Función de emergencia para inicializar manualmente
      window.forceInitChoices = function () {
        console.log('🚨 Forzando inicialización manual...');
        if (window.Choices) {
          initializeAllChoicesFields();
          showDiagnostics();
        } else {
          console.error('❌ Choices.js no disponible para inicialización manual');
        }
      };

      // Re-aplicar estilos cuando se abran los modales
      document.addEventListener('click', function (event) {
        const modalTriggers = ['[data-modal="expertModal"]', '[data-modal="editExpertModal"]', '[data-modal="verPerfilExperto"]'];

        if (modalTriggers.some(selector => event.target.closest(selector))) {
          setTimeout(() => {
            applyChoicesStyles('#expertModal');
            applyChoicesStyles('#editExpertModal');
            applyChoicesStyles('#verPerfilExperto');
          }, 300);
        }
      });

      console.log('✅ Sistema centralizado de Choices.js listo');

      // SCRIPT ESPECÍFICO PARA FORZAR INICIALIZACIÓN DE HABILIDADES
      document.addEventListener('DOMContentLoaded', function () {
        setTimeout(function () {
          // Forzar inicialización específica para habilidades si no está funcionando
          const habilidadesFields = ['habilidades', 'skills', 'ver_habilidades'];

          habilidadesFields.forEach(fieldId => {
            const element = document.getElementById(fieldId);
            if (element && !element.classList.contains('choices-initialized')) {
              console.log(`🔧 Forzando inicialización de ${fieldId}...`);

              try {
                const choicesInstance = new Choices(element, {
                  allowHTML: true,
                  removeItemButton: true,
                  placeholderValue: 'Selecciona habilidades',
                  searchPlaceholderValue: 'Buscar habilidades...',
                  noResultsText: 'No se encontraron resultados',
                  itemSelectText: 'Presiona para seleccionar',
                  duplicateItemsAllowed: false,
                  searchEnabled: true
                });

                element.classList.add('choices-initialized');
                console.log(`✅ ${fieldId} inicializado correctamente con Choices.js`);

                // Aplicar estilos específicos
                setTimeout(() => {
                  const modalId = element.closest('.modal-expert').id;
                  applyChoicesStyles('#' + modalId);
                }, 100);

              } catch (error) {
                console.error(`❌ Error forzando inicialización de ${fieldId}:`, error);
              }
            }
          });
        }, 1500); // Esperar un poco más para asegurar que todo esté cargado
      });

      // OBSERVER PARA DETECTAR CUANDO SE ABRE EL MODAL Y FORZAR HABILIDADES
      const modalObserver = new MutationObserver(function (mutations) {
        mutations.forEach(function (mutation) {
          if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
            const target = mutation.target;
            if (target.id === 'expertModal' && target.style.display === 'flex') {
              console.log('👁️ Modal detectado abierto, verificando habilidades...');

              setTimeout(function () {
                const habilidadesSelect = document.getElementById('habilidades');
                if (habilidadesSelect && !habilidadesSelect.classList.contains('choices-initialized')) {
                  console.log('🔧 Observer: Inicializando habilidades...');

                  try {
                    const choicesInstance = new Choices(habilidadesSelect, {
                      allowHTML: true,
                      removeItemButton: true,
                      placeholderValue: 'Selecciona habilidades',
                      searchPlaceholderValue: 'Buscar habilidades...',
                      noResultsText: 'No se encontraron resultados',
                      itemSelectText: 'Presiona para seleccionar',
                      duplicateItemsAllowed: false,
                      searchEnabled: true
                    });

                    habilidadesSelect.classList.add('choices-initialized');
                    console.log('✅ Observer: Habilidades inicializadas!');

                    applyChoicesStyles('#expertModal');

                  } catch (error) {
                    console.error('❌ Observer: Error inicializando habilidades:', error);
                  }
                } else if (habilidadesSelect && habilidadesSelect.classList.contains('choices-initialized')) {
                  console.log('🔄 Observer: Reactivando habilidades en modal abierto...');

                  // Asegurar que el campo sea funcional
                  const choicesContainer = habilidadesSelect.parentNode.querySelector('.choices');
                  if (choicesContainer) {
                    choicesContainer.style.display = 'block';
                    choicesContainer.style.opacity = '1';
                    choicesContainer.style.pointerEvents = 'auto';

                    // Forzar re-render
                    if (habilidadesSelect.choices && habilidadesSelect.choices.enable) {
                      habilidadesSelect.choices.enable();
                    }

                    console.log('✅ Observer: Habilidades reactivadas!');
                  }
                }
              }, 300);
            }
          }
        });
      });

      // Observar el modal
      const expertModal = document.getElementById('expertModal');
      if (expertModal) {
        modalObserver.observe(expertModal, {
          attributes: true,
          attributeFilter: ['style']
        });
        console.log('👁️ Observer activado para expertModal');
      }
    });
  </script>

  <script src="/assets/js/admin/admin-common.js"></script>
  <script src="/assets/js/admin/admin-expertos.js"></script>
  <script src="/assets/js/admin/admin-expertos.bootstrap.js"></script>

  <!-- Debug script -->
  <script>
    console.log('🔍 Debug: Verificando datos inyectados');
    const expertosScript = document.getElementById('initial-expertos');
    if (expertosScript) {
      const data = JSON.parse(expertosScript.textContent);
      console.log('📊 Expertos inyectados:', data);
      console.log('📊 Cantidad de expertos:', data ? data.length : 0);
    } else {
      console.warn('⚠️ No se encontró el script initial-expertos');
    }

    // Debug esencial - verificar elementos principales
    const btnAdd = document.getElementById('btnAddExpert');
    const modal = document.getElementById('expertModal');
    const tbody = document.querySelector('.admin-table tbody');

    console.log('� Verificación elementos:', {
      btnAddExpert: btnAdd ? '✅' : '❌',
      modal: modal ? '✅' : '❌',
      tabla: tbody ? '✅' : '❌'
    });

    // Event listener directo como respaldo
    document.addEventListener('DOMContentLoaded', function () {
      const btnAddExpert = document.getElementById('btnAddExpert');
      if (btnAddExpert) {
        btnAddExpert.addEventListener('click', function () {
          console.log('🔘 Abriendo modal directamente...');
          const modal = document.getElementById('expertModal');
          if (modal) {
            modal.style.display = 'flex';
            console.log('✅ Modal abierto');

            // FORZAR INICIALIZACIÓN DE HABILIDADES INMEDIATAMENTE
            setTimeout(function () {
              const habilidadesSelect = document.getElementById('habilidades');
              if (habilidadesSelect && !habilidadesSelect.classList.contains('choices-initialized')) {
                console.log('🔧 Inicializando habilidades directamente...');

                try {
                  // Destruir cualquier instancia previa
                  if (habilidadesSelect.choices) {
                    habilidadesSelect.choices.destroy();
                  }

                  const choicesInstance = new Choices(habilidadesSelect, {
                    allowHTML: true,
                    removeItemButton: true,
                    placeholderValue: 'Selecciona habilidades',
                    searchPlaceholderValue: 'Buscar habilidades...',
                    noResultsText: 'No se encontraron resultados',
                    itemSelectText: 'Presiona para seleccionar',
                    duplicateItemsAllowed: false,
                    searchEnabled: true,
                    addItemText: (value) => `Presiona Enter para añadir <b>"${value}"</b>`,
                    maxItemText: (maxItemCount) => `Solo se pueden seleccionar ${maxItemCount} elementos`,
                    uniqueItemText: 'Solo se pueden añadir valores únicos'
                  });

                  habilidadesSelect.classList.add('choices-initialized');
                  console.log('✅ Habilidades inicializadas correctamente!');

                  // Aplicar estilos
                  applyChoicesStyles('#expertModal');

                } catch (error) {
                  console.error('❌ Error inicializando habilidades:', error);
                }
              } else if (habilidadesSelect && habilidadesSelect.classList.contains('choices-initialized')) {
                console.log('ℹ️ Habilidades ya están inicializadas');

                // Asegurar que el campo funcione correctamente
                const choicesContainer = habilidadesSelect.parentNode.querySelector('.choices');
                if (choicesContainer) {
                  choicesContainer.style.opacity = '1';
                  choicesContainer.style.pointerEvents = 'auto';
                  console.log('✅ Habilidades reactivadas en modal abierto');
                }
              }
            }, 200); // Ejecutar después de que el modal se abra
          }
        });
        console.log('✅ Event listener de respaldo activado');
      }
    });
  </script>

</body>

</html>
