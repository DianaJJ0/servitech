<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gestión de Usuarios - Servitech Admin</title>
  <link rel="stylesheet" href="/assets/css/administrador.css" />
  <link rel="stylesheet" href="/assets/css/admin.css" />
  <link rel="stylesheet" href="/assets/css/admin-responsive.css" />
  <link rel="stylesheet" href="/assets/css/admin-components.css" />
  <!-- page-specific CSS -->
  <link rel="stylesheet" href="/assets/css/admin-clientes.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
</head>

<body>

  <div class="admin-layout">
    <%- include('../componentes/navbarAdmin.ejs') %>
      <main class="admin-main">
        <!-- Header con búsqueda y perfil -->
        <header class="admin-header">
          <div class="header-search">
            <i class="fas fa-search"></i>
            <input type="text" id="inputBuscarUsuario" placeholder="Buscar usuarios..." />
          </div>
          <div class="header-actions">
            <div class="notification-icon">
              <i class="fas fa-bell"></i>
              <span class="notification-badge">5</span>
            </div>
            <div class="admin-profile">
              <img src="https://i.pravatar.cc/150?img=11" alt="Admin profile" class="profile-img" />
              <div class="profile-info">
                <span class="profile-name">Admin ServiTech</span>
                <span class="profile-role">Administrador</span>
              </div>
              <i class="fas fa-chevron-down"></i>
            </div>
          </div>
        </header>

        <div class="admin-content">

          <!-- Título, Nuevo usuario, Exportar -->
          <div class="page-header">
            <h1>Gestión de Usuarios</h1>
            <div class="page-actions">
              <button class="btn-primary" id="btnAddUser">
                <i class="fas fa-plus"></i>
                <span>Nuevo usuario</span>
              </button>
              <button class="btn-outline">
                <i class="fas fa-file-export"></i>
                <span>Exportar</span>
              </button>
            </div>
          </div>

          <!-- Filtros y tabla de usuarios -->
          <div class="clientes-grid">
            <!-- Filtros -->
            <div class="table-container clientes-grid__filters">
              <div class="clientes-filtros">
                <h3 class="clientes-filtros__title">Filtros</h3>
                <div class="clientes-filtros__group">
                  <label class="clientes-filtros__label">Estado</label>
                  <select class="clientes-filtros__select" id="filtroEstadoUsuario">
                    <option value="">Todos los estados</option>
                    <option value="activo">Activos</option>
                    <option value="inactivo">Inactivos</option>
                    <option value="suspendido">Suspendidos</option>
                  </select>
                </div>
                <div class="clientes-filtros__group">
                  <label class="clientes-filtros__label">Fecha de registro</label>
                  <select class="clientes-filtros__select" id="filtroFechaRegistroUsuario">
                    <option value="">Todas las fechas</option>
                    <option value="today">Hoy</option>
                    <option value="week">Esta semana</option>
                    <option value="month">Este mes</option>
                    <option value="year">Este año</option>
                  </select>
                </div>
                <button class="btn-primary clientes-filtros__btn clientes-filtros__btn--center">
                  <i class="fas fa-filter"></i>
                  <span>Aplicar filtros</span>
                </button>
              </div>
            </div>

            <!-- Tabla de usuarios -->
            <div class="table-container">
              <div class="clientes-list">
                <table class="admin-table">
                  <thead>
                    <tr>
                      <th>Usuario</th>
                      <th>Email</th>
                      <th>Rol</th>
                      <th>Estado</th>
                      <th>Acciones</th>
                    </tr>
                  </thead>
                  <tbody id="usuarios-tbody">
                    <!-- Los usuarios serán cargados dinámicamente via fetch a /api/usuarios -->
                    <tr id="usuarios-loading-row">
                      <td colspan="5">Cargando usuarios...</td>
                    </tr>
                  </tbody>
                </table>
              </div>
              <!-- Paginación -->
              <div class="admin-pagination"
                style="margin-top:12px; display:flex; align-items:center; justify-content:space-between; gap:12px;">
                <div id="usuarios-pagination" class="admin-pagination__pages"></div>
                <div style="display:flex; gap:8px; align-items:center;">
                  <label style="color:var(--admin-text-secondary); font-size:13px;">Filas por página</label>
                  <select id="usuarios-page-size"
                    style="padding:8px 10px; border-radius:6px; background:var(--admin-card-bg); color:var(--admin-text-primary); border:1px solid var(--admin-border-color);">
                    <option value="5">5</option>
                    <option value="10" selected>10</option>
                    <option value="25">25</option>
                    <option value="50">50</option>
                  </select>
                </div>
              </div>
              
            </div>

          </div>

        </div>

      </main>
  </div>

  <!-- Scripts para la funcionalidad de la página -->
  <script src="/assets/js/admin/admin-common.js"></script>
  <script src="/assets/js/admin/admin-usuarios.js"></script>

  <!-- Modales: Ver perfil y Editar perfil -->

  <!--css para modal-->
  <style>
    :root {
      --admin-bg: #0e1525;
      --admin-card-bg: #1c2333;
      --admin-border-color: #2b3245;
      --admin-hover-bg: #252e43;
      --admin-accent-color: #3a8eff;
      --admin-accent-secondary: #12d8fa;
      --admin-text-primary: #f5f5f5;
      --admin-text-secondary: #a0a0a0;
      --admin-shadow: 0 4px 12px #00000040;
      --admin-radius: 12px;
      --admin-transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* Modal base */
    .admin-modal {
      position: fixed;
      inset: 0;
      display: none;
      z-index: 9998;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }

    .admin-modal__backdrop {
      position: absolute;
      inset: 0;
      background: rgba(4, 8, 16, 0.7);
      backdrop-filter: blur(8px);
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .admin-modal__dialog {
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%) scale(0.95);
      width: min(560px, 90vw);
      max-height: 90vh;
      background: var(--admin-card-bg);
      color: var(--admin-text-primary);
      border: 1px solid var(--admin-border-color);
      box-shadow:
        var(--admin-shadow),
        0 0 0 1px rgba(255, 255, 255, 0.05);
      border-radius: var(--admin-radius);
      overflow: hidden;
      opacity: 0;
      transition: var(--admin-transition);
    }

    .admin-modal.active .admin-modal__backdrop {
      opacity: 1;
    }

    .admin-modal.active .admin-modal__dialog {
      opacity: 1;
      transform: translate(-50%, -50%) scale(1);
    }

    /* Header */
    .admin-modal__header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 20px 24px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.03) 0%, transparent 100%);
      position: relative;
    }

    .admin-modal__header::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: linear-gradient(90deg, transparent, var(--admin-border-color), transparent);
    }

    .admin-modal__header h3 {
      margin: 0;
      font-size: 20px;
      font-weight: 600;
      color: var(--admin-text-primary);
      letter-spacing: -0.01em;
    }

    .admin-modal__close {
      background: transparent;
      border: none;
      color: var(--admin-text-secondary);
      font-size: 24px;
      cursor: pointer;
      padding: 6px;
      border-radius: 8px;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: var(--admin-transition);
    }

    .admin-modal__close:hover {
      background: var(--admin-hover-bg);
      color: var(--admin-text-primary);
      transform: rotate(90deg);
    }

    /* Body */
    .admin-modal__body {
      padding: 24px;
      max-height: calc(90vh - 140px);
      overflow-y: auto;
      scrollbar-width: thin;
      scrollbar-color: var(--admin-border-color) transparent;
    }

    .admin-modal__body::-webkit-scrollbar {
      width: 6px;
    }

    .admin-modal__body::-webkit-scrollbar-track {
      background: transparent;
    }

    .admin-modal__body::-webkit-scrollbar-thumb {
      background-color: var(--admin-border-color);
      border-radius: 3px;
    }

    .view-user {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .view-user__header {
      display: flex;
      gap: 16px;
      align-items: flex-start;
    }

    .view-user img {
      width: 84px;
      height: 84px;
      border-radius: 12px;
      background: linear-gradient(135deg, var(--admin-accent-color), var(--admin-accent-secondary));
      object-fit: cover;
      border: 2px solid var(--admin-border-color);
      flex-shrink: 0;
    }

    .view-user__info {
      flex: 1;
    }

    .view-user h4 {
      margin: 0 0 8px 0;
      font-size: 18px;
      color: var(--admin-text-primary);
      font-weight: 600;
    }

    .view-user p {
      margin: 6px 0;
      color: var(--admin-text-secondary);
      font-size: 14px;
      line-height: 1.5;
    }

    .view-user strong {
      color: var(--admin-text-primary);
      font-weight: 600;
    }

    .view-user__details {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      padding-top: 16px;
      border-top: 1px solid rgba(255, 255, 255, 0.05);
    }

    .view-user__detail-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .view-user__detail-label {
      font-size: 12px;
      color: var(--admin-text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .view-user__detail-value {
      font-size: 14px;
      color: var(--admin-text-primary);
    }

    /* Footer */
    .admin-modal__footer {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      padding: 20px 24px;
      border-top: 1px solid rgba(255, 255, 255, 0.05);
      background: linear-gradient(0deg, rgba(255, 255, 255, 0.02) 0%, transparent 100%);
    }

    /* Buttons (local styles to avoid depending on global classes) */
    .admin-modal .btn-outline {
      background: transparent;
      color: var(--admin-text-primary);
      border: 1px solid var(--admin-border-color);
      padding: 10px 18px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: var(--admin-transition);
    }

    .admin-modal .btn-outline:hover {
      background: var(--admin-hover-bg);
      border-color: rgba(255, 255, 255, 0.1);
      transform: translateY(-1px);
    }

    .admin-modal .btn-primary {
      background: linear-gradient(90deg, var(--admin-accent-color), var(--admin-accent-secondary));
      color: #072034;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      box-shadow: 0 6px 18px rgba(58, 142, 255, 0.15);
      transition: var(--admin-transition);
    }

    .admin-modal .btn-primary:hover {
      filter: brightness(1.05);
      transform: translateY(-1px);
      box-shadow: 0 8px 24px rgba(58, 142, 255, 0.25);
    }

    /* Form styles */
    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-size: 14px;
      font-weight: 500;
      color: var(--admin-text-primary);
    }

    .form-group input {
      width: 100%;
      padding: 12px 16px;
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid var(--admin-border-color);
      border-radius: 8px;
      color: var(--admin-text-primary);
      font-size: 14px;
      transition: var(--admin-transition);
    }

    /* Select mejorado: forzar colores del tema, ocultar flecha nativa y añadir una personalizada */
    .form-group select {
      width: 100%;
      padding: 12px 16px;
      padding-right: 44px;
      /* espacio para la flecha */
      /* fondo oscuro consistente */
      background-color: var(--admin-card-bg);
      /* flecha en color claro y una sutil línea interior para profundidad */
      background-image: linear-gradient(45deg, transparent 50%, var(--admin-text-primary) 50%), linear-gradient(135deg, var(--admin-text-primary) 50%, transparent 50%), linear-gradient(to right, rgba(255, 255, 255, 0.02), rgba(255, 255, 255, 0.02));
      background-position: calc(100% - 18px) calc(50% - 2px), calc(100% - 13px) calc(50% - 2px), 0 0;
      background-size: 6px 6px, 6px 6px, 100% 100%;
      background-repeat: no-repeat;
      border: 1px solid var(--admin-border-color);
      border-radius: 8px;
      color: var(--admin-text-primary);
      font-size: 14px;
      transition: var(--admin-transition);
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
    }

    /* Ocultar expand arrow en Edge/IE */
    .form-group select::-ms-expand {
      display: none;
    }

    /* Intento de estilizar las opciones (no soportado por todos los navegadores) */
    /* Opciones: fondo oscuro y texto claro. Añadimos hover/selected con contraste ligero */
    .form-group select option {
      background: var(--admin-card-bg);
      color: var(--admin-text-primary);
    }

    .form-group select option:hover,
    .form-group select option:focus,
    .form-group select option:checked {
      background: rgba(255, 255, 255, 0.06);
      color: var(--admin-text-primary);
    }

    /* Estado disabled o no seleccionado menos destacable */
    .form-group select option[disabled],
    .form-group select option[aria-disabled='true'] {
      color: var(--admin-text-secondary);
    }

    /* Asegurar que al enfocar el select se muestre el fondo oscuro también */
    .form-group select:focus {
      background-color: var(--admin-card-bg);
      color: var(--admin-text-primary);
    }

    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: var(--admin-accent-color);
      box-shadow: 0 0 0 3px rgba(58, 142, 255, 0.1);
    }

    .form-group input:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Status badges */
    .status {
      display: inline-flex;
      align-items: center;
      padding: 6px 12px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
      gap: 6px;
    }

    .status::before {
      content: '';
      width: 6px;
      height: 6px;
      border-radius: 50%;
    }

    .status.active {
      background: rgba(58, 142, 255, 0.12);
      color: var(--admin-accent-color);
    }

    .status.active::before {
      background: var(--admin-accent-color);
    }

    .status.inactive {
      background: rgba(255, 255, 255, 0.03);
      color: var(--admin-text-secondary);
    }

    .status.inactive::before {
      background: var(--admin-text-secondary);
    }

    .status.suspendido {
      background: rgba(255, 77, 79, 0.12);
      color: #ff4d4f;
    }

    .status.suspendido::before {
      background: #ff4d4f;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .admin-modal__dialog {
        width: 95vw;
        max-height: 95vh;
      }

      .admin-modal__header,
      .admin-modal__body,
      .admin-modal__footer {
        padding: 16px 20px;
      }

      .view-user__header {
        flex-direction: column;
        align-items: center;
        text-align: center;
      }

      .view-user__details {
        grid-template-columns: 1fr;
      }

      .admin-modal__footer {
        flex-direction: column-reverse;
      }

      .admin-modal__footer button {
        width: 100%;
      }
    }

    @media (max-width: 480px) {
      .admin-modal__header h3 {
        font-size: 18px;
      }

      .view-user img {
        width: 72px;
        height: 72px;
      }

      .view-user h4 {
        font-size: 16px;
      }
    }

    /* small accessibility helpers */
    .admin-modal[aria-hidden="true"] {
      display: none !important;
    }

    /* Focus management for accessibility */
    .admin-modal__close:focus,
    .btn-outline:focus,
    .btn-primary:focus,
    .form-group input:focus,
    .form-group select:focus {
      outline: 2px solid var(--admin-accent-color);
      outline-offset: 2px;
    }

    /* Pagination styles (scoped to this page) */
    .admin-pagination {
      margin-top: 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 8px 12px;
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.01), transparent);
      border: 1px solid var(--admin-border-color);
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.25);
    }

    .admin-pagination__pages {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .admin-pagination .btn-outline {
      padding: 8px 10px;
      min-width: 36px;
      height: 36px;
      border-radius: 8px;
      background: transparent;
      color: var(--admin-text-primary);
      border: 1px solid var(--admin-border-color);
      transition: var(--admin-transition);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
    }

    .admin-pagination .btn-outline:hover:not([disabled]) {
      background: var(--admin-hover-bg);
      transform: translateY(-2px);
      border-color: rgba(255, 255, 255, 0.06);
    }

    .admin-pagination .btn-outline[disabled] {
      opacity: 0.45;
      cursor: not-allowed;
      transform: none;
    }

    /* Página activa */
    .admin-pagination .btn-outline[aria-current="page"],
    .admin-pagination .btn-outline.active {
      background: linear-gradient(90deg, var(--admin-accent-color), var(--admin-accent-secondary));
      color: #072034;
      border-color: transparent;
      box-shadow: 0 6px 18px rgba(58, 142, 255, 0.12);
      transform: none;
      font-weight: 700;
    }

    /* Selector de filas por página */
    .admin-pagination select {
      padding: 8px 10px;
      border-radius: 6px;
      background: var(--admin-card-bg);
      color: var(--admin-text-primary);
      border: 1px solid var(--admin-border-color);
      font-size: 13px;
    }

    @media (max-width: 640px) {
      .admin-pagination {
        flex-direction: column;
        align-items: stretch;
      }

      .admin-pagination__pages {
        justify-content: center;
        flex-wrap: wrap;
      }

      .admin-pagination>div:last-child {
        justify-self: end;
      }
    }
  </style>

  <!--Ver perfil-->
  <div id="modalViewUser" class="admin-modal" style="display:none;">
    <div class="admin-modal__backdrop"></div>
    <div class="admin-modal__dialog">
      <header class="admin-modal__header">
        <h3>Ver perfil de usuario</h3>
        <button class="admin-modal__close" data-close>&times;</button>
      </header>
      <div class="admin-modal__body">
        <div class="view-user">
          <div class="view-user__header">
            <img id="view-avatar" src="" alt="Avatar" />
            <div class="view-user__info">
              <h4 id="view-nombre"></h4>
              <p id="view-email"></p>
            </div>
          </div>
          <div class="view-user__details">
            <div class="view-user__detail-group">
              <span class="view-user__detail-label">Roles</span>
              <span class="view-user__detail-value" id="view-roles"></span>
            </div>
            <div class="view-user__detail-group">
              <span class="view-user__detail-label">Estado</span>
              <span class="view-user__detail-value" id="view-estado"></span>
            </div>
          </div>
          <div id="view-infoExperto" style="display:none;">
            <h5>Información experto</h5>
            <p id="view-descripcion"></p>
            <p><strong>Categorías:</strong> <span id="view-categorias"></span></p>
          </div>
        </div>
      </div>
      <footer class="admin-modal__footer">
        <button class="btn-outline" data-close>Cerrar</button>
      </footer>
    </div>
  </div>

  <!-- Editar perfil -->
  <div id="modalEditUser" class="admin-modal" style="display:none;">
    <div class="admin-modal__backdrop"></div>
    <div class="admin-modal__dialog">
      <header class="admin-modal__header">
        <h3>Editar perfil de usuario</h3>
        <button class="admin-modal__close" data-close>&times;</button>
      </header>
      <div class="admin-modal__body">
        <form id="formEditUser">
          <input type="hidden" id="edit-user-id" />
          <div class="form-group">
            <label>Nombre</label>
            <input type="text" id="edit-nombre" />
          </div>
          <div class="form-group">
            <label>Apellido</label>
            <input type="text" id="edit-apellido" />
          </div>
          <div class="form-group">
            <label>Email</label>
            <input type="email" id="edit-email" disabled />
          </div>
          <div class="form-group">
            <label>Roles (coma separado)</label>
            <input type="text" id="edit-roles" placeholder="cliente,experto,admin" />
          </div>
          <div class="form-group">
            <label>Estado</label>
            <select id="edit-estado">
              <option value="activo">Activo</option>
              <option value="inactivo">Inactivo</option>
              <option value="suspendido">Suspendido</option>
            </select>
          </div>
        </form>
      </div>
      <footer class="admin-modal__footer">
        <button class="btn-outline" data-close>Cancelar</button>
        <button class="btn-primary" id="btnSaveEditUser">Guardar</button>
      </footer>
    </div>
  </div>

  <script>
    (function () {
      // Utilidades modal mejoradas: usan la clase `active` para activar animaciones y manejan aria-hidden
      function openModal(id) {
        const m = document.getElementById(id);
        if (!m) return;
        m.setAttribute('aria-hidden', 'false');
        m.style.display = 'block';
        // small delay to allow the browser to apply display before starting transition
        requestAnimationFrame(() => {
          m.classList.add('active');
        });
        document.body.classList.add('modal-open');
      }

      function closeModalByElement(el) {
        const m = el.closest('.admin-modal');
        if (!m) return;
        m.classList.remove('active');
        m.setAttribute('aria-hidden', 'true');
        // wait for CSS transition to finish before hiding the element
        setTimeout(() => {
          m.style.display = 'none';
        }, 260);
        document.body.classList.remove('modal-open');
      }

      function closeModalById(id) {
        const m = document.getElementById(id);
        if (!m) return;
        m.classList.remove('active');
        m.setAttribute('aria-hidden', 'true');
        setTimeout(() => { m.style.display = 'none'; }, 260);
        document.body.classList.remove('modal-open');
      }

      document.addEventListener('click', function (e) {
        const btn = e.target.closest('[data-action]');
        if (btn) {
          const action = btn.getAttribute('data-action');
          const row = btn.closest('tr');
          if (!row) return;
          const userId = row.getAttribute('data-user-id') || '';
          // Obtener datos desde la fila (más fiable sería pedir al servidor por id)
          const cols = row.children;
          const nombre = cols[0] ? cols[0].innerText.trim() : '';
          const email = cols[1] ? cols[1].innerText.trim() : '';
          const roles = cols[2] ? cols[2].innerText.trim() : '';
          const estado = cols[3] ? cols[3].innerText.trim() : '';

          if (action === 'view') {
            // rellenar modal view
            document.getElementById('view-nombre').innerText = nombre;
            document.getElementById('view-email').innerText = email;
            document.getElementById('view-roles').innerText = roles;
            document.getElementById('view-estado').innerText = estado;
            // avatar si hay img
            const img = row.querySelector('img');
            const avatarSrc = img ? img.src : '';
            const vAvatar = document.getElementById('view-avatar');
            vAvatar.src = avatarSrc || '';
            // info experto: si el row tiene data-info-experto
            const infoExp = row.getAttribute('data-info-experto') || '';
            if (infoExp) {
              try {
                const parsed = JSON.parse(infoExp);
                document.getElementById('view-descripcion').innerText = parsed.descripcion || '';
                document.getElementById('view-categorias').innerText = (parsed.categorias || []).join(', ');
                document.getElementById('view-infoExperto').style.display = '';
              } catch (err) {
                document.getElementById('view-infoExperto').style.display = 'none';
              }
            } else {
              document.getElementById('view-infoExperto').style.display = 'none';
            }
            openModal('modalViewUser');
          } else if (action === 'edit') {
            // rellenar campos edit
            document.getElementById('edit-user-id').value = userId || '';
            const parts = (nombre || '').split('\n')[0] || nombre;
            document.getElementById('edit-nombre').value = parts || '';
            // intentar separar nombre/apellido si hay espacio
            const nameParts = parts.split(' ');
            document.getElementById('edit-apellido').value = nameParts.length > 1 ? nameParts.slice(1).join(' ') : '';
            document.getElementById('edit-email').value = email || '';
            document.getElementById('edit-roles').value = roles || '';
            document.getElementById('edit-estado').value = estado || 'activo';
            openModal('modalEditUser');
          } else if (action === 'delete') {
            if (!confirm('¿Desactivar usuario?')) return;
            // Llamada a backend para desactivar user por admin (usar email)
            const emailEnc = encodeURIComponent(email);
            const headers = { 'Content-Type': 'application/json' };
            if (window.API_KEY) headers['x-api-key'] = window.API_KEY;
            fetch('/api/usuarios/' + emailEnc, { method: 'DELETE', credentials: 'same-origin', headers })
              .then(async r => {
                const body = await r.json().catch(() => null);
                if (r.ok) { row.remove(); } else { alert('Error al desactivar: ' + (body && body.mensaje ? body.mensaje : JSON.stringify(body))); }
              }).catch(err => { console.error(err); alert('Error al desactivar usuario'); });
          }
        }

        // cierre de modales por elementos con data-close
        if (e.target.matches('[data-close]') || e.target.closest('[data-close]')) {
          const el = e.target.closest('[data-close]') || e.target;
          // intentamos cerrar usando el elemento dentro del modal
          closeModalByElement(el);
        }
      });

      // Guardar cambios del modal editar
      const btnSave = document.getElementById('btnSaveEditUser');
      if (btnSave) {
        btnSave.addEventListener('click', function () {
          const id = document.getElementById('edit-user-id').value;
          const email = document.getElementById('edit-email').value;
          const nombre = document.getElementById('edit-nombre').value;
          const apellido = document.getElementById('edit-apellido').value;
          const roles = document.getElementById('edit-roles').value.split(',').map(s => s.trim()).filter(Boolean);
          const estado = document.getElementById('edit-estado').value;
          const payload = { nombre, apellido, roles, estado };
          const headers = { 'Content-Type': 'application/json' };
          if (window.API_KEY) headers['x-api-key'] = window.API_KEY;
          fetch('/api/usuarios/' + encodeURIComponent(email), { method: 'PUT', credentials: 'same-origin', headers, body: JSON.stringify(payload) })
            .then(async r => {
              const body = await r.json().catch(() => null);
              if (!r.ok) throw new Error((body && body.mensaje) || r.status);
              // actualizar fila en tabla: buscar por data-user-id o por email
              const rows = Array.from(document.querySelectorAll('#usuarios-tbody tr'));
              const row = rows.find(tr => (tr.getAttribute('data-user-id') || '') === id || (tr.children[1] && tr.children[1].innerText.trim() === email));
              if (row) {
                const nameEl = row.children[0].querySelector('.user-details h4');
                if (nameEl) nameEl.innerText = nombre + ' ' + apellido;
                row.children[2].innerText = roles.join(', ');
                row.children[3].innerHTML = '<span class="status ' + (estado === 'activo' ? 'active' : 'inactive') + '">' + estado + '</span>';
              }
              // cerrar modal por id
              closeModalById('modalEditUser');
            })
            .catch(err => { console.error(err); alert('Error guardando usuario: ' + (err && err.message)); });
        });
      }

    })();
  </script>
</body>

</html>
