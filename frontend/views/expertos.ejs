<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Expertos - Servitech</title>
  <link rel="stylesheet" href="/assets/css/base.css" />
  <link rel="stylesheet" href="/assets/css/expertos.css" />
  <link rel="stylesheet" href="/assets/css/componentes.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
</head>

<body>
  <%- include('componentes/header') %>

    <% // Helper local para formatear precio sin depender de locales del sistema %>
      <% function formatPrice(n){
           if (n === undefined || n === null) return null;
           // Aceptar strings num√©ricos
           var num = Number(n);
           if (Number.isNaN(num)) return null;
           try {
             return Math.round(num).toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.');
           } catch (e) { return String(n); }
         }
      %>

        <main class="container">
          <section class="hero-section">
            <h1 class="hero-title">Encuentra tu Experto</h1>
            <p class="hero-subtitle">Filtra entre nuestros profesionales certificados para encontrar el que mejor se
              adapte
              a tus necesidades</p>
          </section>

          <!-- banner DEBUG eliminado -->

          <div class="expert-layout">
            <aside class="filter-sidebar">
              <div class="filter-card">
                <h3 class="filter-title">Filtrar Expertos</h3>
                <form class="filter-form" id="filterForm">
                  <div class="filter-group">
                    <label class="filter-label">Por nombre o especializaci√≥n</label>
                    <!-- El atributo 'name' es 'busqueda' -->
                    <input type="text" name="busqueda" class="filter-input" placeholder="JavaScript, React, etc." />
                  </div>

                  <div class="filter-group">
                    <label for="categoria-filter" class="filter-label">Categor√≠a</label>
                    <!-- El atributo 'name' es 'categoria' -->
                    <select id="categoria-filter" name="categoria" class="filter-input">
                      <option value="">Todas las categor√≠as</option>
                      <% if (categorias && categorias.length> 0) { %>
                        <% categorias.forEach(function(cat) { %>
                          <option value="<%= cat.nombre %>">
                            <%= cat.nombre %>
                          </option>
                          <% }); %>
                            <% } %>
                    </select>
                  </div>

                  <div class="filter-actions">
                    <button type="submit" class="btn btn-primary btn-apply">
                      <i class="fas fa-filter"></i> Aplicar filtros
                    </button>
                    <a href="/expertos" class="btn btn-secondary btn-reset">
                      <i class="fas fa-undo"></i> Limpiar
                    </a>
                  </div>
                </form>
              </div>
            </aside>

            <section class="expert-list-section">
              <div class="expert-list-header">
                <h2 class="expert-list-title">Expertos disponibles <span class="expert-count">(<%= expertos.length %>
                      resultados)</span></h2>
                <div class="sort-options">
                  <!-- El atributo 'name' es 'sortBy' y se env√≠a con el formulario -->
                  <select name="sortBy" class="sort-select" form="filterForm" onchange="this.form.submit()">
                    <option value="puntuacion">Mejor puntuados</option>
                    <option value="precio_asc">Precio: menor a mayor</option>
                    <option value="precio_desc">Precio: mayor a menor</option>
                    <option value="nombre_asc">Nombre (A-Z)</option>
                  </select>
                </div>
              </div>

              <div class="expert-grid">
                <% if (expertos && expertos.length> 0) { %>
                  <% expertos.forEach(function(experto) { %>
                    <article class="expert-card">
                      <div class="expert-card-header">
                        <img
                          src="https://ui-avatars.com/api/?name=<%= experto.nombre %>+<%= experto.apellido %>&background=3a8eff&color=fff&size=96"
                          alt="Foto de <%= experto.nombre %>" class="expert-photo">
                        <div class="expert-info">
                          <h3 class="expert-name">
                            <%= experto.nombre %>
                              <%= experto.apellido %>
                          </h3>
                          <%
                            // Resolver especialidad desde varias posibles ubicaciones
                            var espDisplay = null;
                            try {
                              var _esp = null;
                              if (experto && experto.infoExperto && experto.infoExperto.especialidad) {
                                _esp = experto.infoExperto.especialidad;
                              } else if (experto && experto.especialidad) {
                                _esp = experto.especialidad;
                              }
                              if (_esp) {
                                if (typeof _esp === 'object') {
                                  // Extraer nombre de objeto de especialidad
                                  espDisplay = _esp.nombre || _esp.nombreEspecialidad || _esp.descripcion || null;
                                } else {
                                  // Convertir a string si no es objeto
                                  espDisplay = String(_esp);
                                }
                                // Limpiar y normalizar el texto
                                if (espDisplay) {
                                  espDisplay = espDisplay.toString().trim().replace(/\s+/g, ' ');
                                }
                              }
                              // Si no hay especialidad, intentar derivarla desde la primera categor√≠a del experto
                              if (
                                !espDisplay &&
                                experto &&
                                experto.infoExperto &&
                                Array.isArray(experto.infoExperto.categorias) &&
                                experto.infoExperto.categorias.length > 0 &&
                                Array.isArray(categorias)
                              ) {
                                var catRef = experto.infoExperto.categorias[0];
                                if (catRef) {
                                  var foundCat = categorias.find(function(c) {
                                    if (!c) return false;
                                    // Comparar por ID (diferentes formatos posibles)
                                    if (catRef._id && c._id && String(c._id) === String(catRef._id)) return true;
                                    if (catRef.id && c._id && String(c._id) === String(catRef.id)) return true;
                                    // Comparar por nombre (case insensitive)
                                    if (catRef.nombre && c.nombre) {
                                      var refNombre = String(catRef.nombre).trim().toLowerCase();
                                      var catNombre = String(c.nombre).trim().toLowerCase();
                                      if (refNombre === catNombre) return true;
                                    }
                                    return false;
                                  });
                                  if (foundCat && Array.isArray(foundCat.especialidades) && foundCat.especialidades.length > 0) {
                                    var primeraEspecialidad = foundCat.especialidades.find(function(esp) { return esp && esp.nombre; });
                                    if (primeraEspecialidad) {
                                      espDisplay = primeraEspecialidad.nombre.trim();
                                    }
                                  }
                                }
                              }
                            } catch (e) {
                              espDisplay = null;
                            }
                            // Valor por defecto si todo falla
                            if (!espDisplay) espDisplay = '';
                          %>
                            <div class="expert-specialty-block">
                              <div class="tag-group-title">Especialidad</div>
                              <p class="expert-specialty <%= espDisplay ? '' : 'placeholder' %>">
                                <%= espDisplay ? espDisplay : 'Sin especificar' %>
                              </p>
                            </div>
                            <div class="expert-rating"><span class="rating-stars">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</span> <span
                                class="rating-value">5.0</span></div>
                        </div>
                      </div>

                      <div class="expert-card-body">
                        <div class="expert-bio-block">
                          <div class="tag-group-title">Biograf√≠a profesional</div>
                          <% if (experto.infoExperto && experto.infoExperto.descripcion) { %>
                            <p class="expert-description">
                              <%= experto.infoExperto.descripcion.length> 300 ?
                                (experto.infoExperto.descripcion.substring(0, 300) + '...') :
                                experto.infoExperto.descripcion %>
                            </p>
                            <% } else { %>
                              <p class="expert-description placeholder">No hay biograf√≠a p√∫blica</p>
                              <% } %>
                        </div>

                        <div class="expert-tags">
                          <% /* Grupos separados: Categor√≠as y Habilidades */ %>
                            <% if (experto.infoExperto && experto.infoExperto.categorias &&
                              experto.infoExperto.categorias.length>0) { %>
                              <div class="tag-group tag-group-categories">
                                <div class="tag-group-title">Categor√≠as</div>
                                <div class="tag-list">
                                  <% experto.infoExperto.categorias.slice(0,6).forEach(function(cat){ %>
                                    <span class="category-tag">
                                      <%= (cat && cat.nombre) ? cat.nombre : cat %>
                                    </span>
                                    <% }); %>
                                </div>
                              </div>
                              <% } %>

                                <% if (experto.infoExperto && Array.isArray(experto.infoExperto.skills) &&
                                  experto.infoExperto.skills.length>0) { %>
                                  <div class="tag-group tag-group-skills">
                                    <div class="tag-group-title">Habilidades</div>
                                    <div class="tag-list">
                                      <% experto.infoExperto.skills.slice(0,8).forEach(function(s){ %>
                                        <span class="skill-tag">
                                          <%= s %>
                                        </span>
                                        <% }); %>
                                    </div>
                                  </div>
                                  <% } %>
                        </div>

                        <% if (experto.infoExperto && (experto.infoExperto.telefonoContacto ||
                          (Array.isArray(experto.infoExperto.diasDisponibles) &&
                          experto.infoExperto.diasDisponibles.length>0))) { %>
                          <div class="expert-contact" style="margin-top:0.5rem;color:var(--text-secondary);">
                            <% if (experto.infoExperto.telefonoContacto) { %>
                              <small>üìû <%= experto.infoExperto.telefonoContacto %></small>
                              <% } %>
                                <% if (Array.isArray(experto.infoExperto.diasDisponibles) &&
                                  experto.infoExperto.diasDisponibles.length>0) { %>
                                  <small style="margin-left:0.5rem;">üóì <%= experto.infoExperto.diasDisponibles.join(', ') %></small>
                            <% } %>
                          </div>
                        <% } %>
                      </div>

                  <div class="expert-card-footer">
                    <% if (experto.infoExperto || experto) {
                         // Buscar precio por hora en varios lugares posibles
                         var rawPrecio = null;
                         if (experto && experto.infoExperto && typeof experto.infoExperto.precioPorHora !== 'undefined') {
                           rawPrecio = experto.infoExperto.precioPorHora;
                         } else if (typeof experto.precioPorHora !== 'undefined') {
                           rawPrecio = experto.precioPorHora;
                         } else if (typeof experto.precio !== 'undefined') {
                           rawPrecio = experto.precio;
                         }
                         var _fp = formatPrice(rawPrecio);
                    %>
                      <% if (_fp) { %>
                        <div class="expert-price">$<%= _fp %>/h</div>
                      <% } else { %>
                        <div class="expert-price">Consultar precio</div>
                      <% } %>
                    <% } else { %>
                      <div class="expert-price">Consultar precio</div>
                    <% } %>
                      <a href="/expertos/<%= experto._id %>/calendario" class="btn btn-primary btn-profile"><i
                                  class="fas fa-calendar-alt"></i> Ver disponibilidad</a>
                  </div>
                </article>
                <% }); %>
                  <% } else { %>
                    <div class="no-experts-found">
                      <h3>No se encontraron expertos</h3>
                      <p>No hay expertos que coincidan con tus criterios de b√∫squeda. Intenta con otros filtros.</p>
                    </div>
                    <% } %>
          </div>
        </section>
      </div>
  </main>
  <%- include('componentes/footer') %>
                                      <script src="/assets/js/common.js"></script>
                                      <script src="/assets/js/expertos.js"></script>
                                      <script>
                                        // SSE listener: recarga la p√°gina cuando el servidor notifica cambios en usuarios/experts
                                        (function () {
                                          try {
                                            var es = new EventSource('/sse/stream');
                                            es.addEventListener('usuarios:update', function (e) {
                                              try {
                                                // simple reload to reflect new expert
                                                console.info('SSE usuarios:update received, reloading page');
                                                window.location.reload();
                                              } catch (err) { }
                                            });
                                          } catch (e) {
                                            // ignore if SSE not supported
                                          }
                                        })();
                                      </script>

</body>

</html>
